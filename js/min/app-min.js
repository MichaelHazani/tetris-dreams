"use strict";$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,a,o,n,i,r,s,d,l,c,p,E,m,h,u,w,y,T,g,H,R,f,M,v,x,b,k,L,P=new THREE.Raycaster,j=new THREE.Vector2,B=window.innerWidth,S=window.innerHeight,z=0,C=1,A=!1,W=!1,F=!1,q=!1,O=!1,D=!1,V=performance.now(),G=new THREE.Vector3,I=new THREE.AudioListener,N,J,_,U,Y,X,Z,K,Q,ee,te=-20,ae=100,oe=8,ne=0,ie=[],re=[],se=new THREE.LoadingManager,de,le=!1,ce=!1,pe=!0,Ee=0,me=500,he=3e3,ue="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(ue){var we=document.body,ye=function(e){document.pointerLockElement===we||document.mozPointerLockElement===we||document.webkitPointerLockElement===we?(A=!0,b.enabled=!0):b.enabled=!1},Te=function(e){};document.addEventListener("pointerlockchange",ye,!1),document.addEventListener("mozpointerlockchange",ye,!1),document.addEventListener("webkitpointerlockchange",ye,!1),document.addEventListener("pointerlockerror",Te,!1),document.addEventListener("mozpointerlockerror",Te,!1),document.addEventListener("webkitpointerlockerror",Te,!1),document.body.addEventListener("click",function(e){if(we.requestPointerLock=we.requestPointerLock||we.mozRequestPointerLock||we.webkitRequestPointerLock,we.exitPointerLock=we.exitPointerLock||we.mozExitPointerLock||we.webkitExitPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===we||document.mozFullscreenElement===we||document.mozFullScreenElement===we)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),we.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),we.requestFullscreen=we.requestFullscreen||we.mozRequestFullscreen||we.mozRequestFullScreen||we.webkitRequestFullscreen,we.requestFullscreen()}else we.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var ge=["./audio/1.ogg","./audio/2.ogg","./audio/3.ogg","./audio/4.ogg","./audio/5.ogg","./audio/6.ogg","./audio/7.ogg","./audio/8.ogg"];e=function(){function e(e){$(A).text(e),$(A).fadeIn(3e3),$(A).fadeOut(1500)}function i(){n.aspect=window.innerWidth/window.innerHeight,n.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),L.style.top=window.innerHeight/2+"px",L.style.left=window.innerWidth/2+"px",j.style.top=window.innerHeight-50+"px",j.style.left=window.innerWidth/2+"px"}function c(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,g.load("./JSON/R-shape.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:39168,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.add(i),i.load(ge[Math.floor(7*Math.random())]),t.name="brick",o.add(t)})},2e3)}function E(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,g.load("./JSON/cube.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:128,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function h(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,g.load("./JSON/squiggly.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:32896,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function w(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,g.load("./JSON/pedestal.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:13789470,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function T(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,g.load("./JSON/longline.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:8388608,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function H(){var e=new THREE.TextureLoader;f=new SPE.Group({texture:{value:e.load("../images/star1.png")},fog:!1,maxParticleCount:3e4}),M=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:4,position:{value:new THREE.Vector3(0,100,0),spread:new THREE.Vector3(1e3,30,1e3)},opacity:[.9],size:{value:[0,1,0]},particleCount:3e4,isStatic:!1}),f.addEmitter(M),o.add(f.mesh)}se.onProgress=function(e,t,a){console.log(e,t,a)},v=new THREE.Clock,a=new THREE.WebGLRenderer({antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(window.innerWidth,window.innerHeight),a.setClearColor(0),document.body.appendChild(a.domElement),o=new Physijs.Scene,o.setGravity(new THREE.Vector3(0,te,0)),Q=new Audio("./audio/theme.ogg"),Q.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=1},!1),Q.volume=1,ee=new Audio("./audio/shepard.ogg"),ee.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=0},!1),ee.volume=0,ee.currentTime=30,n=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),n.position.set(0,0,10),o.add(n),n.add(I);var x=new THREE.Fog(16777215,1,1e3);b=new THREE.PointerLockControls(n),o.add(b.getObject());var L=document.createElement("img");L.src="./images/crosshair.png",L["class"]="chair",L.style.position="absolute",document.body.appendChild(L),L.style.top=window.innerHeight/2+"px",L.style.left=window.innerWidth/2+"px";var j=document.createElement("div");j["class"]="hitcounter",j.style.position="absolute",j.style.top=window.innerHeight-50+"px",j.style.left=window.innerWidth/2+"px",j.style.color="#fff",j.style.fontFamily="Raleway",j.style.fontWeight="100",j.style.fontSize="2rem",document.body.appendChild(j),$(j).text(z),j.style.display="none";var A=document.createElement("div");A["class"]="levelcounter",A.style.position="absolute",A.style.top=window.innerHeight/2+"px",A.style.left=window.innerWidth/2+"px",A.style.color="#fff",A.style.width=window.innerWidth/3+"px",A.style.height=window.innerHeight/3+"px",A.style.marginLeft=-1*window.innerWidth/6+"px",A.style.marginTop=-1*window.innerHeight/1.4+"px",A.style.fontFamily="Raleway",A.style.fontWeight="100",A.style.fontSize="40rem",A.style.textAlign="center",A.style.color="#333",document.body.appendChild(A),$(A).text(C),$(A).hide();var V=document.createElement("div");V["class"]="blackScreen",V.style.position="absolute",V.zIndex=134,V.style.top="0px",V.style.left="0px",V.style.backgroundColor="black",V.style.width=window.innerWidth+"px",V.style.height=window.innerHeight+"px",V.style.margin=0,V.style.color="white",V.style.opacity=0,V.style.textAlign="center";var N=document.createElement("div");N.innerHTML="<p class='p1d' style='opacity:0'>You almost made it.</p><p class='p2d' style='opacity:0'>Just one more level.</p><br><br><p class='p3d' style='opacity:0'>Try again?</p><p class='p4d' style='opacity:0'>I bet you'll beat it this time.</p><p class='p5d' style='opacity:0'>What's the harm?</p><div class='p5d' id='links' style='opacity: 0; width: 100%; position: absolute; float: right; bottom: 35px; line-height: 1em; font-size:0.7em; font-family:helvetica; color: #ccc'>&#169 2016 Michael Hazani <br> <a href='http://michaelhazani.com' alt='Michael Hazani's website' target='_blank' style='text-decoration:none; color:#ccc;'>website</a> | <a href='https://github.com/MichaelHazani/tetris-horror' alt='Hazani's Github' target='_blank' style='text-decoration:none; color:#ccc;'>GitHub</a></div>",N.style.fontSize="1em",N.style.textAlign="center",N.style.lineHeight="4rem",N.style.marginTop="2%",N.style.marginLeft="20px",N.style.position="absolute",N.style.top="0px",N.style.backgroundColor="black",N.style.color="white",N.style.width=window.innerWidth+"px",N.style.height=window.innerHeight+"px",V.appendChild(N);var J=document.createElement("div");J["class"]="introScreen",J.style.position="absolute",J.zIndex=134,J.style.top="0px",J.style.left="0px",J.style.backgroundColor="black",J.style.width=window.innerWidth+"px",J.style.height=window.innerHeight+"px",J.style.margin=0,J.style.color="white";var _=document.createElement("div");_.innerHTML="<div><p class='1p' style='opacity: 0'>\"..But nowadays, the populace at large isn't aware of our discoveries since we first encountered the Tetris Effect - <br>chronic, virtually irreversible phenomena such as neural hijacking, pattern-oriented compulsive obsessions or post-Pavlovian conditioning...</p><br><p class='2p' style='opacity: 0'>No one wants to be told about thousands of cases, women and men around the world <br> who spend their lives confined to padded cells, doomed to play a neverending game in their heads ad infinitum, <br> sans loved ones, sans thought, sans sleep...\" </p></div><br><br><span id='credits' class='3p' style='float:right; font-style: italic; margin-right:40px; opacity: 0'>A.L.Pajitnov, PhD, \"The Viral And The Virtual: Towards A New Pathology\"</span>",_.style.fontSize="1.1em",_.style.textAlign="left",_.style.lineHeight="4rem",_.style.marginTop="2%",_.style.marginLeft="20px",_.style.position="absolute",_.style.top="0px",_.style.backgroundColor="black",_.style.color="white",_.style.width=window.innerWidth+"px",_.style.height=window.innerHeight+"px",J.appendChild(_),we.appendChild(J);var U=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),W=!0;break;case 37:case 65:q=!0;break;case 40:case 83:F=!0;break;case 39:case 68:O=!0;break;case 32:D===!0&&(G.y+=200),D=!1;break;case 80:le=!le}},Y=function(e){switch(e.keyCode){case 38:case 87:W=!1;break;case 37:case 65:q=!1;break;case 40:case 83:F=!1;break;case 39:case 68:O=!1}};document.addEventListener("keydown",U,!1),document.addEventListener("keyup",Y,!1),window.addEventListener("resize",i,!1),p=m=u=y=g=new THREE.JSONLoader,de=setInterval(function(){function e(e){switch(e){case 1:c();break;case 2:E();break;case 3:h();break;case 4:w();break;case 5:T()}}if(!le&&!ce&&!pe){var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),Ee++,Ee>=me&&clearInterval(de)}},he);var X=function(e){ce=!0,document.exitPointerLock(),$(ee).animate({volume:0},2e3),Q.currentTime=0,Q.volume=1,Q.play(),we.appendChild(V),$(V).animate({opacity:1},2e3),$(".p1d").animate({opacity:1},1e4),$(".p2d").animate({opacity:1},2e4),$(".p3d").animate({opacity:1},3e4),$(".p4d").animate({opacity:1},5e4),$(".p5d").animate({opacity:1},6e4),setTimeout(function(){window.addEventListener("mousedown",function(){location.reload()})},1e4)},Z=10770263;R=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshPhongMaterial({color:Z}),0),R.rotation.x=Math.PI,R.position.set(0,0,0),R.name="plane",R.addEventListener("collision",function(e){e.dead||(e.dead=!0,ie.push(e),ne++),ne>11-2*C&&X(C)}),o.add(R),r=new THREE.PointLight(16777215,.5),r.position.set(150,200,150),o.add(r),s=new THREE.PointLight(16777215,.5),s.position.set(150,200,-150),o.add(s),d=new THREE.PointLight(16777215,.5),d.position.set(-150,200,150),o.add(d),l=new THREE.PointLight(16777215,.5),l.position.set(-150,200,-150),o.add(l),requestAnimationFrame(t);var K=new THREE.BoxGeometry(700,700,700),oe=[],ue=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var ue=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var ue=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/top1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var ue=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/bottom1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var ue=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var ue=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var ye=new THREE.MeshFaceMaterial(oe),Te=new THREE.Mesh(K,ye);Te.position.y=250,o.add(Te);var He=new THREE.BoxGeometry(740,740,740),Re=[],ue=new THREE.TextureLoader;Re.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Re.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Re.push(new THREE.MeshBasicMaterial({map:ue.load("./images/top2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Re.push(new THREE.MeshBasicMaterial({map:ue.load("./images/bottom2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Re.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Re.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var fe=new THREE.MeshFaceMaterial(Re),Me=new THREE.Mesh(He,fe);Me.position.y=245,o.add(Me);var ve=new THREE.BoxGeometry(720,720,720),xe=[],ue=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/top3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/bottom3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var be=new THREE.MeshFaceMaterial(xe),ke=new THREE.Mesh(ve,be);ke.position.y=245,o.add(ke);var Le=new THREE.BoxGeometry(760,760,760),Pe=[],ue=new THREE.TextureLoader;Pe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Pe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Pe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/top4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Pe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/bottom4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Pe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.TextureLoader;Pe.push(new THREE.MeshBasicMaterial({map:ue.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var je=new THREE.MeshFaceMaterial(Pe),Be=new THREE.Mesh(Le,je);Be.position.y=245,o.add(Be),H();var Se=new THREE.BokehPass(o,n,{focus:1,aperture:.02,maxblur:1.02,width:B,height:S});Se.renderToScreen=!0,k=new THREE.EffectComposer(a),k.addPass(new THREE.RenderPass(o,n)),k.addPass(Se),n.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){function e(){o.remove(Te),R.material.color=new THREE.Color(16711935);for(var e=0;e<ke.material.materials.length;e++)TweenLite.to(ke.material.materials[e],3,{opacity:1})}function t(){o.remove(ke),R.material.color=new THREE.Color(8650815);for(var e=0;e<Me.material.materials.length;e++)TweenLite.to(Me.material.materials[e],3,{opacity:1})}function a(){o.remove(Me),R.material.color=new THREE.Color(4544102);for(var e=0;e<Be.material.materials.length;e++)TweenLite.to(Be.material.materials[e],3,{opacity:1})}var i=new THREE.Vector2;i.x=0,i.y=0,P.setFromCamera(i,n);for(var r=P.intersectObjects(o.children),s=0;s<r.length;s++)if("plane"==r[s].object.name||"Points"==r[s].object.type||r[s].object.dead||(r[s].object.material.wireframe=!0,r[s].object.dead=!0,re.push(r[s].object),z++,$(j).text(z)),z>=10*C){he-=600*C,ae+=45*C,te-=40,o.setGravity(new THREE.Vector3(0,te,0)),ne=0;for(var s=0;s<ie.length;s++)o.remove(ie[s]);switch(C){case 1:for(var s=0;s<Te.material.materials.length;s++)TweenLite.to(Te.material.materials[s],5,{opacity:0,onComplete:e});break;case 2:for(var s=0;s<ke.material.materials.length;s++)TweenLite.to(ke.material.materials[s],5,{opacity:0,onComplete:t});break;case 3:for(var s=0;s<Me.material.materials.length;s++)TweenLite.to(Me.material.materials[s],5,{opacity:0,onComplete:a})}C++}},!1),$(".1p").animate({opacity:1},1e4),$(".2p").animate({opacity:1},3e4),$(".3p").animate({opacity:1},6e4),Q.play(),$(J).click(function(){$(Q).animate({volume:0},1e3),setTimeout(function(){Q.stop()},1500),$(ee).animate({volume:.5},6e3),$(J).fadeOut(2e3),setTimeout(function(){we.removeChild(J)},2e3),pe=!pe})},window.onerror=function(){return!0},t=function(){if(f.tick(v.getDelta()),A){var e=performance.now(),a=(e-V)/500;G.x-=10*G.x*a,G.z-=10*G.z*a,G.y-=9.8*100*a,W&&(G.z-=400*a),F&&(G.z+=400*a),q&&(G.x-=400*a),O&&(G.x+=400*a),b.getObject().translateX(G.x*a),b.getObject().translateY(G.y*a),b.getObject().translateZ(G.z*a),b.getObject().position.y<10&&(G.y=0,b.getObject().position.y=10),V=e}re.length>0&&re.forEach(function(e){e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.setLinearVelocity(new THREE.Vector3(0,1.5,0)),e.setAngularVelocity(new THREE.Vector3(0,.2,0))}),requestAnimationFrame(t),le?(ee.pause(),document.exitPointerLock()):(ue||document.requestPointerLock(),ee.play(),o.simulate(),k.render())},e()});