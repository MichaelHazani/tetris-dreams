$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,a,o,n,i,r,s,d,l,c,p,u,m,h=performance.now(),E,w,y,g=new THREE.Raycaster,f=new THREE.Vector2,T=window.innerWidth,v=window.innerHeight,H=0,R=1,M=!1,b=!1,x=!1,k=!1,L=!1,P=!1,B=new THREE.Vector3,j=new THREE.AudioListener,z,S,C,A,F,q,D,O,W=new Audio("./audio/theme.ogg"),G=new Audio("./audio/shepard.ogg"),V=new Audio("./audio/endfx.ogg"),I,N,J=-20,_=100,U=8,Y=0,X=[],Z=[],K,Q=!1,ee=!1,te,ae=!0,oe=0,ne=500,ie=3e3,re="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(re){var se=document.body,de=function(e){document.pointerLockElement===se||document.mozPointerLockElement===se||document.webkitPointerLockElement===se?(M=!0,E.enabled=!0):E.enabled=!1},le=function(e){};document.addEventListener("pointerlockchange",de,!1),document.addEventListener("mozpointerlockchange",de,!1),document.addEventListener("webkitpointerlockchange",de,!1),document.addEventListener("pointerlockerror",le,!1),document.addEventListener("mozpointerlockerror",le,!1),document.addEventListener("webkitpointerlockerror",le,!1),document.body.addEventListener("click",function(e){if(se.requestPointerLock=se.requestPointerLock||se.mozRequestPointerLock||se.webkitRequestPointerLock,se.exitPointerLock=se.exitPointerLock||se.mozExitPointerLock||se.webkitExitPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){document.fullscreenElement!==se&&document.mozFullscreenElement!==se&&document.mozFullScreenElement!==se||(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),se.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),se.requestFullscreen=se.requestFullscreen||se.mozRequestFullscreen||se.mozRequestFullScreen||se.webkitRequestFullscreen,se.requestFullscreen()}else se.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var ce=["./audio/1.ogg","./audio/2.ogg","./audio/3.ogg","./audio/4.ogg","./audio/5.ogg","./audio/6.ogg","./audio/7.ogg","./audio/8.ogg"];e=function(){function r(e){$(levelCounter).text(e),$(levelCounter).fadeIn(3e3),$(levelCounter).fadeOut(1500)}function h(){i.aspect=window.innerWidth/window.innerHeight,i.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),F.style.top=window.innerHeight/2+"px",F.style.left=window.innerWidth/2+"px",q.style.top=window.innerHeight-50+"px",q.style.left=window.innerWidth/2+"px"}function y(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*_+1),o=t*Math.floor(Math.random()*_+1);p.load("./JSON/R-shape.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:39168,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=o,t.rotation.x=a,t.rotation.y=o,t.rotation.z=a;var i=new THREE.PositionalAudio(j);A.load(ce[Math.floor(Math.random()*ce.length)],function(e){i.setBuffer(e),i.setRefDistance(60),i.volume=.3,i.play()}),t.name="R-shape",n.add(t)})},2e3)}function f(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*_+1),o=t*Math.floor(Math.random()*_+1);p.load("./JSON/cube.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:128,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=o,t.rotation.x=a,t.rotation.y=o,t.rotation.z=a,t.name="cube";var i=new THREE.PositionalAudio(j);A.load(ce[Math.floor(Math.random()*ce.length)],function(e){i.setBuffer(e),i.setRefDistance(60),i.volume=.3,t.add(i),i.play()}),n.add(t)})},2e3)}function M(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*_+1),o=t*Math.floor(Math.random()*_+1);p.load("./JSON/squiggly.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:32896,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=o,t.rotation.x=a,t.rotation.y=o,t.rotation.z=a,t.name="squiggly";var i=new THREE.PositionalAudio(j);A.load(ce[Math.floor(Math.random()*ce.length)],function(e){i.setBuffer(e),i.setRefDistance(60),i.volume=.3,t.add(i),i.play()}),n.add(t)})},2e3)}function z(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*_+1),o=t*Math.floor(Math.random()*_+1);p.load("./JSON/pedestal.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:13789470,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=o,t.rotation.x=a,t.rotation.y=o,t.rotation.z=a,t.name="pedestal";var i=new THREE.PositionalAudio(j);A.load(ce[Math.floor(Math.random()*ce.length)],function(e){i.setBuffer(e),i.setRefDistance(60),i.volume=.3,t.add(i),i.play()}),n.add(t)})},2e3)}function S(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*_+1),o=t*Math.floor(Math.random()*_+1);p.load("./JSON/longline.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:8388608,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=o,t.rotation.x=a,t.rotation.y=o,t.rotation.z=a,t.name="longline";var i=new THREE.PositionalAudio(j);A.load(ce[Math.floor(Math.random()*ce.length)],function(e){i.setBuffer(e),i.setRefDistance(60),i.volume=.3,t.add(i),i.play()}),n.add(t)})},2e3)}W.removeEventListener("canplaythrough",e,!1);var C=new THREE.LoadingManager;C.onProgress=function(e,t,a){console.log(e,t,a),console.log("progress")},C.onLoad=function(){console.log("done")},C.onError=function(e){console.warn("Loading Error",e)},m=new THREE.Clock,a=new THREE.WebGLRenderer({antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(window.innerWidth,window.innerHeight),a.setClearColor(0),document.body.appendChild(a.domElement),n=new Physijs.Scene,n.setGravity(new THREE.Vector3(0,J,0)),W.volume=1,G.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=0},!1),G.volume=0,G.currentTime=30,i=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,1,1e3),i.position.set(0,0,10),n.add(i),i.add(j);var A=new THREE.AudioLoader;E=new THREE.PointerLockControls(i),n.add(E.getObject());var F=document.createElement("img");F.src="./images/crosshair.png",F["class"]="chair",F.style.position="absolute",document.body.appendChild(F),F.style.top=window.innerHeight/2+"px",F.style.left=window.innerWidth/2+"px";var q=document.createElement("div");q["class"]="hitcounter",q.style.position="absolute",q.style.top="20px",q.style.left="97%",q.style.color="#fff",q.style.fontFamily="Raleway",q.style.fontWeight="100",q.style.fontSize="2rem",document.body.appendChild(q),$(q).text(H);var D=document.createElement("div");D["class"]="blackScreen",D.style.position="absolute",D.zIndex=134,D.style.top="0px",D.style.left="0px",D.style.backgroundColor="black",D.style.width=window.innerWidth+"px",D.style.height=window.innerHeight+"px",D.style.margin=0,D.style.color="white",D.style.opacity=0,D.style.textAlign="center";var O=document.createElement("div");O.innerHTML="<p class='p1d' style='opacity:0'>You almost made it.</p><p class='p2d' style='opacity:0'>Just one more level.</p><br><br><p class='p3d' style='opacity:0'>Try again?</p><p class='p4d' style='opacity:0'>I bet you'll beat it this time.</p><p class='p5d' style='opacity:0'>What's the harm?</p><div class='p5d' id='links' style='opacity: 0; width: 100%; position: absolute; float: right; bottom: 35px; line-height: 1em; font-size:0.7em; font-family:helvetica; color: #ccc'>&#169 2016 Michael Hazani <br> <a href='http://michaelhazani.com' alt='Michael Hazani's website' target='_blank' style='text-decoration:none; color:#ccc;'>website</a> | <a href='https://github.com/MichaelHazani/tetris-horror' alt='Hazani's Github' target='_blank' style='text-decoration:none; color:#ccc;'>GitHub</a></div>",O.style.fontSize="1em",O.style.textAlign="center",O.style.lineHeight="4rem",O.style.marginTop="2%",O.style.marginLeft="20px",O.style.position="absolute",O.style.top="0px",O.style.backgroundColor="black",O.style.color="white",O.style.width=window.innerWidth+"px",O.style.height=window.innerHeight+"px",D.appendChild(O);var U=document.createElement("div");U["class"]="introScreen",U.style.position="absolute",U.zIndex=134,U.style.top="0px",U.style.left="0px",U.style.backgroundColor="black",U.style.width=window.innerWidth+"px",U.style.height=window.innerHeight+"px",U.style.margin=0,U.style.color="white";var re=document.createElement("div");re.innerHTML="<div><p class='1p' style='opacity: 0'>\"...But nowadays, the populace at large isn't aware of our discoveries since we first encountered the Tetris Effect - <br>chronic, virtually irreversible phenomena such as neural hijacking, pattern-oriented compulsive obsessions or post-Pavlovian conditioning...</p><br><p class='2p' style='opacity: 0'>No one wants to be told about thousands of cases, women and men around the world <br> who spend their lives confined to padded cells, doomed to play a neverending game in their heads ad infinitum, <br> sans loved ones, sans thought, sans sleep...\" </p></div><br><br><span id='credits' class='3p' style='float:right; font-style: italic; margin-right:40px; opacity: 0'>A.L.Pajitnov, PhD, \"The Viral And The Virtual: Towards A New Pathology\"</span>",re.style.fontSize="1.1em",re.style.textAlign="left",re.style.lineHeight="4rem",re.style.marginTop="2%",re.style.marginLeft="20px",re.style.position="absolute",re.style.top="0px",re.style.backgroundColor="black",re.style.color="white",re.style.width=window.innerWidth+"px",re.style.height=window.innerHeight+"px",U.appendChild(re),se.appendChild(U);var de=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),b=!0;break;case 37:case 65:k=!0;break;case 40:case 83:x=!0;break;case 39:case 68:L=!0;break;case 32:P===!0&&(B.y+=200),P=!1;break;case 80:Q=!Q}},le=function(e){switch(e.keyCode){case 38:case 87:b=!1;break;case 37:case 65:k=!1;break;case 40:case 83:x=!1;break;case 39:case 68:L=!1}};document.addEventListener("keydown",de,!1),document.addEventListener("keyup",le,!1),window.addEventListener("resize",h,!1),p=new THREE.JSONLoader,K=setInterval(function(){function e(e){switch(e){case 1:y();break;case 2:f();break;case 3:M();break;case 4:z();break;case 5:S()}}if(!Q&&!ee&&!ae){var t=Math.round(5*Math.random())+1;e(t%2==0?1:t%3==0?2:t%4==0?3:t%5==0?4:5),oe++,oe>=ne&&clearInterval(K)}},ie),te=function(e){ee=!0,document.exitPointerLock(),$(G).animate({volume:0},2e3),V.volume=0,V.loop=!0,V.play(),$(V).animate({volume:.4},2e4),se.appendChild(D),cancelAnimationFrame(o),$(D).animate({opacity:1},2e3),$(".p1d").animate({opacity:1},5e3),$(".p2d").animate({opacity:1},1e4),$(".p3d").animate({opacity:1},15e3),$(".p4d").animate({opacity:1},2e4),$(".p5d").animate({opacity:1},25e3),setTimeout(function(){window.addEventListener("mousedown",function(){location.reload()})},1e4)};var pe=10770263;u=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshPhongMaterial({color:pe}),0),u.rotation.x=Math.PI,u.position.set(0,0,0),u.name="plane",u.addEventListener("collision",function(e){e.dead||(e.dead=!0,N=new THREE.PositionalAudio(j),A.load("./audio/crash.ogg",function(e){N.setBuffer(e),N.setRefDistance(100),N.volume=.1,N.play()}),X.push(e),Y++),Y>11-2*R&&te(R)}),n.add(u),s=new THREE.PointLight(16777215,.5),s.position.set(150,200,150),n.add(s),d=new THREE.PointLight(16777215,.5),d.position.set(150,200,-150),n.add(d),l=new THREE.PointLight(16777215,.5),l.position.set(-150,200,150),n.add(l),c=new THREE.PointLight(16777215,.5),c.position.set(-150,200,-150),n.add(c),requestAnimationFrame(t);var ue=new THREE.BoxGeometry(700,700,700),me=[],he=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var he=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var he=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:he.load("./images/top1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var he=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:he.load("./images/bottom1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var he=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var he=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var Ee=new THREE.MeshFaceMaterial(me),we=new THREE.Mesh(ue,Ee);we.position.y=250,n.add(we);var ye=new THREE.BoxGeometry(740,740,740),ge=[],he=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:he.load("./images/top2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:he.load("./images/bottom2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var fe=new THREE.MeshFaceMaterial(ge),Te=new THREE.Mesh(ye,fe);Te.position.y=245,n.add(Te);var ve=new THREE.BoxGeometry(720,720,720),He=[],he=new THREE.TextureLoader;He.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;He.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;He.push(new THREE.MeshBasicMaterial({map:he.load("./images/top3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;He.push(new THREE.MeshBasicMaterial({map:he.load("./images/bottom3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;He.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;He.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Re=new THREE.MeshFaceMaterial(He),Me=new THREE.Mesh(ve,Re);Me.position.y=245,n.add(Me);var be=new THREE.BoxGeometry(760,760,760),xe=[],he=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:he.load("./images/top4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:he.load("./images/bottom4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:he.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ke=new THREE.MeshFaceMaterial(xe),Le=new THREE.Mesh(be,ke);Le.position.y=245,n.add(Le);var Pe=new THREE.BokehPass(n,i,{focus:1,aperture:.02,maxblur:1.02,width:T,height:v});Pe.renderToScreen=!0,w=new THREE.EffectComposer(a),w.addPass(new THREE.RenderPass(n,i)),w.addPass(Pe),document.addEventListener("mousedown",function(){function e(){n.remove(we),u.material.color=new THREE.Color(16711935);for(var e=0;e<Me.material.materials.length;e++)TweenLite.to(Me.material.materials[e],3,{opacity:1})}function t(){n.remove(Me),u.material.color=new THREE.Color(8650815);for(var e=0;e<Te.material.materials.length;e++)TweenLite.to(Te.material.materials[e],3,{opacity:1})}function a(){n.remove(Te),u.material.color=new THREE.Color(4544102);for(var e=0;e<Le.material.materials.length;e++)TweenLite.to(Le.material.materials[e],3,{opacity:1})}var o=new THREE.Vector2;o.x=0,o.y=0,g.setFromCamera(o,i);for(var r=g.intersectObjects(n.children),s=0;s<r.length;s++)if("plane"==r[s].object.name||"Points"==r[s].object.type||r[s].object.dead||(r[s].object.material.wireframe=!0,r[s].object.dead=!0,I=new THREE.PositionalAudio(j),A.load("./audio/hit2.ogg",function(e){I.setBuffer(e),I.setRefDistance(50),I.volume=.4,I.play()}),Z.push(r[s].object),H++,$(q).text(H)),H>=10*R){ie-=600*R,_+=45*R,J-=40,n.setGravity(new THREE.Vector3(0,J,0)),Y=0;for(var s=0;s<X.length;s++)n.remove(X[s]);switch(R){case 1:for(var s=0;s<we.material.materials.length;s++)TweenLite.to(we.material.materials[s],5,{opacity:0,onComplete:e});break;case 2:for(var s=0;s<Me.material.materials.length;s++)TweenLite.to(Me.material.materials[s],5,{opacity:0,onComplete:t});break;case 3:for(var s=0;s<Te.material.materials.length;s++)TweenLite.to(Te.material.materials[s],5,{opacity:0,onComplete:a})}R++}},!1),$(".1p").animate({opacity:1},1e4),$(".2p").animate({opacity:1},15e3),$(".3p").animate({opacity:1},2e4),W.play(),$(U).click(function(){$(W).animate({volume:0},1e3),setTimeout(function(){W.pause()},1500),$(G).animate({volume:.5},6e3),$(U).fadeOut(2e3),setTimeout(function(){se.removeChild(U)},2e3),function e(){var e=document.createElement("img");e.style.position="absolute",e.style.width="35%",e.style.top="80%",e.style.left="32.5%",e.style.opacity="0",e.src="./images/inst.png",document.body.appendChild(e),$(e).animate({opacity:1},2e3,function(){$(e).animate({opacity:0},8e3)})}(),function t(){var e=["this is better than your reality","trust gravity","this level can last forever","food, the prolonger, is abominable","what day is it?","as you wish","have you ever purposefully lost a game?","remember those who fell before you","don't go outside stay in your head don't go","no randomization is completely unorganized. no certainty is without cha0s","which color tastes the best?","the difference between you and a madman is","fractured conscience =/= fractured memory","bits and bytes and ACTG and fine print","a 240p rose is still a røse","sunlight is cancerous","diseases thrive in the wild"],t=document.createElement("div");t.style.position="absolute",t.style.textAlign="center",t.style.width="100%",t.style.top="10%",t.style.color="#fff",t.style.fontFamily="Inconsolata",t.style.fontSize="1.5em",t.style.opacity=0,document.body.appendChild(t);var a=setInterval(function(){var a=e[Math.floor(Math.random()*e.length)];$(t).text(a),$(t).animate({opacity:1},5e3,function(){$(t).animate({opacity:0},5e3)})},15e3)}(),ae=!1})},window.onerror=function(){return!0},t=function(){if(M){var e=performance.now(),a=(e-h)/500;B.x-=10*B.x*a,B.z-=10*B.z*a,B.y-=9.8*100*a,b&&(B.z-=400*a),x&&(B.z+=400*a),k&&(B.x-=400*a),L&&(B.x+=400*a),E.getObject().translateX(B.x*a),E.getObject().translateY(B.y*a),E.getObject().translateZ(B.z*a),E.getObject().position.y<10&&(B.y=0,E.getObject().position.y=10),h=e}Z.length>0&&Z.forEach(function(e){e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.setLinearVelocity(new THREE.Vector3(0,1.5,0)),e.setAngularVelocity(new THREE.Vector3(0,.2,0))}),o=requestAnimationFrame(t),Q?(G.pause(),document.exitPointerLock()):(re||document.requestPointerLock(),G.play(),n.simulate(),w.render())},W.addEventListener("canplaythrough",e,!1)});