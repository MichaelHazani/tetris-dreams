"use strict";$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,o,n,i,a,r,s,d,c,l,u,E,m,h,w,p,y,f,g,R,v,T,H,M,k,b=new THREE.Raycaster,x=new THREE.Vector2,L=window.innerWidth,P=window.innerHeight,j=0,z=1,S=!1,B=!1,C=!1,A=!1,q=!1,F=!1,O=performance.now(),W=new THREE.Vector3,V=new THREE.AudioListener,D,N,G,I,J,_,Y,X,Z,K=-20,Q=200,U=0,ee=[],te=[],oe=0,ne=500,ie=3e3,ae="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(ae){var re=document.body,se=function(e){document.pointerLockElement===re||document.mozPointerLockElement===re||document.webkitPointerLockElement===re?(S=!0,H.enabled=!0):H.enabled=!1},de=function(e){};document.addEventListener("pointerlockchange",se,!1),document.addEventListener("mozpointerlockchange",se,!1),document.addEventListener("webkitpointerlockchange",se,!1),document.addEventListener("pointerlockerror",de,!1),document.addEventListener("mozpointerlockerror",de,!1),document.addEventListener("webkitpointerlockerror",de,!1),document.body.addEventListener("click",function(e){if(re.requestPointerLock=re.requestPointerLock||re.mozRequestPointerLock||re.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===re||document.mozFullscreenElement===re||document.mozFullScreenElement===re)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),re.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),re.requestFullscreen=re.requestFullscreen||re.mozRequestFullscreen||re.mozRequestFullScreen||re.webkitRequestFullscreen,re.requestFullscreen()}else re.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var ce=["../audio/1.ogg","../audio/2.ogg","../audio/3.ogg","../audio/4.ogg","../audio/5.ogg","../audio/6.ogg","../audio/7.ogg","../audio/8.ogg"];e=function(){function e(e){$(x).text(e),$(x).fadeIn(3e3),$(x).fadeOut(1500)}function a(){i.aspect=window.innerWidth/window.innerHeight,i.updateProjectionMatrix(),o.setSize(window.innerWidth,window.innerHeight),T.style.top=window.innerHeight/2+"px",T.style.left=window.innerWidth/2+"px",k.style.top=window.innerHeight-50+"px",k.style.left=window.innerWidth/2+"px"}function s(){setTimeout(function(){var e=Math.floor(Math.random()*Q+1),t=Math.floor(Math.random()*Q+1),o=new THREE.Audio(V);o.setRefDistance(30),o.autoplay=!0,p.load("./JSON/R-shape.json",function(i){var a=new Physijs.BoxMesh(i,new THREE.MeshPhongMaterial({color:39168}));a.scale.set(2,2,2),a.position.y=100,a.position.x=e,a.position.z=t,a.rotation.x=e,a.rotation.y=t,a.rotation.z=e,a.add(o),o.load(ce[Math.floor(7*Math.random())]),a.name="brick",n.add(a)})},2e3)}function c(){setTimeout(function(){var e=Math.floor(Math.random()*Q+1),t=Math.floor(Math.random()*Q+1),o=new THREE.Audio(V);o.setRefDistance(30),o.autoplay=!0,p.load("./JSON/cube.json",function(i){var a=new Physijs.BoxMesh(i,new THREE.MeshPhongMaterial({color:128}));a.scale.set(2,2,2),a.position.y=100,a.position.x=e,a.position.z=t,a.rotation.x=e,a.rotation.y=t,a.rotation.z=e,a.name="brick",o.load(ce[Math.floor(7*Math.random())]),n.add(a)})},2e3)}function u(){setTimeout(function(){var e=Math.floor(Math.random()*Q+1),t=Math.floor(Math.random()*Q+1),o=new THREE.Audio(V);o.setRefDistance(30),o.autoplay=!0,p.load("./JSON/squiggly.json",function(i){var a=new Physijs.BoxMesh(i,new THREE.MeshPhongMaterial({color:32896}));a.scale.set(2,2,2),a.position.y=100,a.position.x=e,a.position.z=t,a.rotation.x=e,a.rotation.y=t,a.rotation.z=e,a.name="brick",o.load(ce[Math.floor(7*Math.random())]),n.add(a)})},2e3)}function m(){setTimeout(function(){var e=Math.floor(Math.random()*Q+1),t=Math.floor(Math.random()*Q+1),o=new THREE.Audio(V);o.setRefDistance(30),o.autoplay=!0,p.load("./JSON/pedestal.json",function(i){var a=new Physijs.BoxMesh(i,new THREE.MeshPhongMaterial({color:13789470}));a.scale.set(2,2,2),a.position.y=100,a.position.x=e,a.position.z=t,a.rotation.x=e,a.rotation.y=t,a.rotation.z=e,a.name="brick",o.load(ce[Math.floor(7*Math.random())]),n.add(a)})},2e3)}function w(){setTimeout(function(){var e=Math.floor(Math.random()*Q+1),t=Math.floor(Math.random()*Q+1),o=new THREE.Audio(V);o.setRefDistance(30),o.autoplay=!0,p.load("./JSON/longline.json",function(i){var a=new Physijs.BoxMesh(i,new THREE.MeshPhongMaterial({color:8388608}));a.scale.set(2,2,2),a.position.y=100,a.position.x=e,a.position.z=t,a.rotation.x=e,a.rotation.y=t,a.rotation.z=e,a.name="brick",o.load(ce[Math.floor(7*Math.random())]),n.add(a)})},2e3)}function y(){var e=new THREE.TextureLoader;g=new SPE.Group({texture:{value:e.load("../images/star1.png")},fog:!1,maxParticleCount:8e3}),R=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:4,position:{value:new THREE.Vector3(0,80,0),spread:new THREE.Vector3(2e3,30,2e3)},opacity:[.7],size:{value:[0,1,0]},particleCount:8e3,isStatic:!1}),g.addEmitter(R),n.add(g.mesh)}v=new THREE.Clock,o=new THREE.WebGLRenderer({antialias:!0}),o.setPixelRatio(window.devicePixelRatio),o.setSize(window.innerWidth,window.innerHeight),o.setClearColor(16777215),document.body.appendChild(o.domElement),n=new Physijs.Scene,n.setGravity(new THREE.Vector3(0,K,0)),Z=new Audio("../audio/bg.ogg"),Z.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=.5},!1),Z.play(),i=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),i.position.set(0,0,10),n.add(i),i.add(V),H=new THREE.PointerLockControls(i),n.add(H.getObject());var T=document.createElement("img");T.src="../images/crosshair.png",T["class"]="chair",T.style.position="absolute",document.body.appendChild(T),T.style.top=window.innerHeight/2+"px",T.style.left=window.innerWidth/2+"px";var k=document.createElement("div");k["class"]="hitcounter",k.style.position="absolute",k.style.top=window.innerHeight-50+"px",k.style.left=window.innerWidth/2+"px",k.style.color="#fff",k.style.fontFamily="Raleway",k.style.fontWeight="100",k.style.fontSize="2rem",document.body.appendChild(k),$(k).text(j),k.style.display="none";var x=document.createElement("div");x["class"]="levelcounter",x.style.position="absolute",x.style.top=window.innerHeight/2+"px",x.style.left=window.innerWidth/2+"px",x.style.color="#fff",x.style.width=window.innerWidth/3+"px",x.style.height=window.innerHeight/3+"px",x.style.marginLeft=-1*window.innerWidth/6+"px",x.style.marginTop=-1*window.innerHeight/1.4+"px",x.style.fontFamily="Raleway",x.style.fontWeight="100",x.style.fontSize="40rem",x.style.textAlign="center",x.style.color="#333",document.body.appendChild(x),$(x).text(z),$(x).hide();var S=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),B=!0;break;case 37:case 65:A=!0;break;case 40:case 83:C=!0;break;case 39:case 68:q=!0;break;case 32:F===!0&&(W.y+=200),F=!1}},O=function(e){switch(e.keyCode){case 38:case 87:B=!1;break;case 37:case 65:A=!1;break;case 40:case 83:C=!1;break;case 39:case 68:q=!1}};document.addEventListener("keydown",S,!1),document.addEventListener("keyup",O,!1),window.addEventListener("resize",a,!1),d=l=E=h=p=new THREE.JSONLoader;var D=setInterval(function(){function e(e){switch(e){case 1:s();break;case 2:c();break;case 3:u();break;case 4:m();break;case 5:w()}}var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),oe++,oe>=ne&&clearInterval(D)},ie),N=13391189;f=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshLambertMaterial({color:N}),0),f.rotation.x=Math.PI,f.position.set(0,0,0),f.name="plane",f.addEventListener("collision",function(e){e.dead||(e.dead=!0,ee.push(e),U++),U>10&&console.log("death")}),n.add(f),r=new THREE.PointLight(16746632,.2),r.position.set(0,347,0),n.add(r);var G=new THREE.AmbientLight(16768477,.2);n.add(G),requestAnimationFrame(t);var I=new THREE.BoxGeometry(700,700,700),J=[],_=new THREE.TextureLoader;J.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide}));var _=new THREE.TextureLoader;J.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide}));var _=new THREE.TextureLoader;J.push(new THREE.MeshBasicMaterial({map:_.load("../images/top3.jpg"),side:THREE.BackSide}));var _=new THREE.TextureLoader;J.push(new THREE.MeshBasicMaterial({map:_.load("../images/bottom3.jpg"),side:THREE.BackSide}));var _=new THREE.TextureLoader;J.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide}));var _=new THREE.TextureLoader;J.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide}));var Y=new THREE.MeshFaceMaterial(J),X=new THREE.Mesh(I,Y);X.position.y=250,n.add(X),y();var ae=new THREE.BokehPass(n,i,{focus:1,aperture:.09,maxblur:1.1,width:L,height:P});ae.renderToScreen=!0,M=new THREE.EffectComposer(o),M.addPass(new THREE.RenderPass(n,i)),M.addPass(ae),i.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){var t=new THREE.Vector2;t.x=0,t.y=0,b.setFromCamera(t,i);for(var o=b.intersectObjects(n.children),a=0;a<o.length;a++)if("plane"!=o[a].object.name&&"Points"!=o[a].object.type&&!o[a].object.dead&&(o[a].object.material.transparent=!0,te.push(o[a].object),o[a].object.dead=!0,j++,$(k).text(j),j>=10*z)){z++,ie-=200*z,Q+=15*z,K-=10,n.setGravity(new THREE.Vector3(0,K,0)),console.log("next up! Level "+z+", dropInterval: "+ie,"dropRadius: "+Q+", gravity: "+K),U=0,console.log(ee);for(var r=n.getObjectByName("brick"),a=0;a<ee.length;a++)console.log(ee[a]),n.remove(ee[a]);e(z)}},!1),e(z),console.log(z)},window.onerror=function(){return!0},t=function(){if(g.tick(v.getDelta()),S){var e=performance.now(),o=(e-O)/500;W.x-=10*W.x*o,W.z-=10*W.z*o,W.y-=9.8*100*o,B&&(W.z-=400*o),C&&(W.z+=400*o),A&&(W.x-=400*o),q&&(W.x+=400*o),H.getObject().translateX(W.x*o),H.getObject().translateY(W.y*o),H.getObject().translateZ(W.z*o),H.getObject().position.y<10&&(W.y=0,H.getObject().position.y=10),O=e}te.length>0&&te.forEach(function(e){e.setLinearVelocity(new THREE.Vector3(0,0,0)),e.setAngularVelocity(new THREE.Vector3(0,0,0)),e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.material.opacity=.5}),requestAnimationFrame(t),n.simulate(),M.render()},e()});