"use strict";$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,n,o,i,a,r,s,c,d,l,u,E,m,h,w,p,f,y,R,T,v,H,g,M,k,x=new THREE.Raycaster,b=new THREE.Vector2,L=window.innerWidth,P=window.innerHeight,j=0,z=1,S=!1,B=!1,C=!1,q=!1,F=!1,O=!1,V=performance.now(),W=new THREE.Vector3,A=-30,G=200,J=[],N=0,I=500,_=3e3,Y="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(Y){var D=document.body,X=function(e){document.pointerLockElement===D||document.mozPointerLockElement===D||document.webkitPointerLockElement===D?(S=!0,g.enabled=!0):g.enabled=!1},Z=function(e){};document.addEventListener("pointerlockchange",X,!1),document.addEventListener("mozpointerlockchange",X,!1),document.addEventListener("webkitpointerlockchange",X,!1),document.addEventListener("pointerlockerror",Z,!1),document.addEventListener("mozpointerlockerror",Z,!1),document.addEventListener("webkitpointerlockerror",Z,!1),document.body.addEventListener("click",function(e){if(D.requestPointerLock=D.requestPointerLock||D.mozRequestPointerLock||D.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===D||document.mozFullscreenElement===D||document.mozFullScreenElement===D)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),D.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),D.requestFullscreen=D.requestFullscreen||D.mozRequestFullscreen||D.mozRequestFullScreen||D.webkitRequestFullscreen,D.requestFullscreen()}else D.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";e=function(){function e(){i.aspect=window.innerWidth/window.innerHeight,i.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight),$(".chair")[0].style.top=window.innerHeight/2+"px",$(".chair")[0].style.left=window.innerWidth/2+"px",H.style.top=window.innerHeight-50+"px",H.style.left=window.innerWidth/2+"px"}function a(){setTimeout(function(){var e=Math.floor(Math.random()*G+1),t=Math.floor(Math.random()*G+1);p.load("./JSON/R-shape.json",function(n){var i=new Physijs.BoxMesh(n,new THREE.MeshPhongMaterial({color:39168}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,o.add(i)})},2e3)}function s(){setTimeout(function(){var e=Math.floor(Math.random()*G+1),t=Math.floor(Math.random()*G+1);p.load("./JSON/cube.json",function(n){var i=new Physijs.BoxMesh(n,new THREE.MeshPhongMaterial({color:128}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,o.add(i)})},2e3)}function d(){setTimeout(function(){var e=Math.floor(Math.random()*G+1),t=Math.floor(Math.random()*G+1);p.load("./JSON/squiggly.json",function(n){var i=new Physijs.BoxMesh(n,new THREE.MeshPhongMaterial({color:32896}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,o.add(i)})},2e3)}function u(){setTimeout(function(){var e=Math.floor(Math.random()*G+1),t=Math.floor(Math.random()*G+1);p.load("./JSON/pedestal.json",function(n){var i=new Physijs.BoxMesh(n,new THREE.MeshPhongMaterial({color:13789470}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,o.add(i)})},2e3)}function m(){setTimeout(function(){var e=Math.floor(Math.random()*G+1),t=Math.floor(Math.random()*G+1);p.load("./JSON/longline.json",function(n){var i=new Physijs.BoxMesh(n,new THREE.MeshPhongMaterial({color:8388608}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,o.add(i)})},2e3)}function w(){var e=new THREE.TextureLoader;R=new SPE.Group({texture:{value:e.load("../images/star1.png")},fog:!1,maxParticleCount:8e3}),T=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:2,position:{value:new THREE.Vector3(0,70,0),spread:new THREE.Vector3(2e3,30,2e3)},particleCount:8e3,isStatic:!0}),R.addEmitter(T),o.add(R.mesh)}v=new THREE.Clock,n=new THREE.WebGLRenderer({antialias:!0}),n.setPixelRatio(window.devicePixelRatio),n.setSize(window.innerWidth,window.innerHeight),n.setClearColor(16777215),document.body.appendChild(n.domElement),o=new Physijs.Scene,o.setGravity(new THREE.Vector3(0,A,0)),i=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),i.position.set(0,0,10),o.add(i),g=new THREE.PointerLockControls(i),o.add(g.getObject());var f=document.createElement("img");f.src="../images/crosshair.png",f["class"]="chair",f.style.position="absolute",document.body.appendChild(f),f.style.top=window.innerHeight/2+"px",f.style.left=window.innerWidth/2+"px";var H=document.createElement("div");H["class"]="hitcounter",H.style.position="absolute",H.style.top=window.innerHeight-50+"px",H.style.left=window.innerWidth/2+"px",H.style.color="#fff",H.style.fontFamily="Raleway",H.style.fontWeight="100",H.style.fontSize="2rem",document.body.appendChild(H),$(H).text(j);var k=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),B=!0;break;case 37:case 65:q=!0;break;case 40:case 83:C=!0;break;case 39:case 68:F=!0;break;case 32:O===!0&&(W.y+=200),O=!1}},b=function(e){switch(e.keyCode){case 38:case 87:B=!1;break;case 37:case 65:q=!1;break;case 40:case 83:C=!1;break;case 39:case 68:F=!1}};document.addEventListener("keydown",k,!1),document.addEventListener("keyup",b,!1),window.addEventListener("resize",e,!1),c=l=E=h=p=new THREE.JSONLoader;var S=setInterval(function(){function e(e){switch(e){case 1:a();break;case 2:s();break;case 3:d();break;case 4:u();break;case 5:m()}}var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),N++,N>=I&&clearInterval(S)},_),V=13391189;y=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshLambertMaterial({color:V}),0),y.rotation.x=Math.PI,y.position.set(0,0,0),y.name="plane",y.addEventListener("collision",function(e){e.dead=!0}),o.add(y),r=new THREE.PointLight(16746632,.2),r.position.set(0,347,0),o.add(r);var Y=new THREE.AmbientLight(16768477,.2);o.add(Y),requestAnimationFrame(t);var D=new THREE.BoxGeometry(700,700,700),X=[],Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/top3.jpg"),side:THREE.BackSide}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/bottom3.jpg"),side:THREE.BackSide}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide}));var K=new THREE.MeshFaceMaterial(X),Q=new THREE.Mesh(D,K);Q.position.y=250,o.add(Q),w();var U=new THREE.BokehPass(o,i,{focus:1,aperture:.09,maxblur:1.1,width:L,height:P});U.renderToScreen=!0,M=new THREE.EffectComposer(n),M.addPass(new THREE.RenderPass(o,i)),M.addPass(U),i.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){var e=new THREE.Vector2;e.x=0,e.y=0,x.setFromCamera(e,i);for(var t=x.intersectObjects(o.children),n=0;n<t.length;n++)"plane"==t[n].object.name||"Points"==t[n].object.type||t[n].object.dead||(t[n].object.material.transparent=!0,J.push(t[n].object),t[n].object.dead=!0,j++,$(H).text(j),j>=10*z&&(z++,_-=200*z,G+=15*z,A-=10,o.setGravity(new THREE.Vector3(0,A,0)),console.log("next up! Level "+z+", dropInterval: "+_,"dropRadius: "+G+", gravity: "+A)))},!1)},window.onerror=function(){return!0},t=function(){if(S){var e=performance.now(),n=(e-V)/500;W.x-=10*W.x*n,W.z-=10*W.z*n,W.y-=9.8*100*n,B&&(W.z-=400*n),C&&(W.z+=400*n),q&&(W.x-=400*n),F&&(W.x+=400*n),g.getObject().translateX(W.x*n),g.getObject().translateY(W.y*n),g.getObject().translateZ(W.z*n),g.getObject().position.y<10&&(W.y=0,g.getObject().position.y=10),V=e}J.length>0&&J.forEach(function(e){e.setLinearVelocity(new THREE.Vector3(0,0,0)),e.setAngularVelocity(new THREE.Vector3(0,0,0)),e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.material.opacity=.5}),requestAnimationFrame(t),o.simulate(),M.render()},e()});