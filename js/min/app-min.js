"use strict";$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,n,o,a,i,r,s,d,c,l,u,E,m,h,w,p,y,f,g,R,T,v,H,M,k,x=new THREE.Raycaster,b=new THREE.Vector2,L=window.innerWidth,P=window.innerHeight,j=0,z=1,S=!1,B=!1,C=!1,A=!1,q=!1,F=!1,W=performance.now(),O=new THREE.Vector3,V=new THREE.AudioListener,D,G,I,J,N,_,Y,X,Z,K=-20,Q=100,U=8,ee=2*Math.round(Math.random())-1,te=0,ne=[],oe=[],ae=0,ie=500,re=3e3,se="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(se){var de=document.body,ce=function(e){document.pointerLockElement===de||document.mozPointerLockElement===de||document.webkitPointerLockElement===de?(S=!0,H.enabled=!0):H.enabled=!1},le=function(e){};document.addEventListener("pointerlockchange",ce,!1),document.addEventListener("mozpointerlockchange",ce,!1),document.addEventListener("webkitpointerlockchange",ce,!1),document.addEventListener("pointerlockerror",le,!1),document.addEventListener("mozpointerlockerror",le,!1),document.addEventListener("webkitpointerlockerror",le,!1),document.body.addEventListener("click",function(e){if(de.requestPointerLock=de.requestPointerLock||de.mozRequestPointerLock||de.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===de||document.mozFullscreenElement===de||document.mozFullScreenElement===de)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),de.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),de.requestFullscreen=de.requestFullscreen||de.mozRequestFullscreen||de.mozRequestFullScreen||de.webkitRequestFullscreen,de.requestFullscreen()}else de.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var ue=["../audio/1.ogg","../audio/2.ogg","../audio/3.ogg","../audio/4.ogg","../audio/5.ogg","../audio/6.ogg","../audio/7.ogg","../audio/8.ogg"];e=function(){function e(e){$(b).text(e),$(b).fadeIn(3e3),$(b).fadeOut(1500)}function i(){a.aspect=window.innerWidth/window.innerHeight,a.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight),v.style.top=window.innerHeight/2+"px",v.style.left=window.innerWidth/2+"px",k.style.top=window.innerHeight-50+"px",k.style.left=window.innerWidth/2+"px"}function s(){setTimeout(function(){var e=ee*Math.floor(Math.random()*Q+1),t=ee*Math.floor(Math.random()*Q+1),n=new THREE.Audio(V);n.setRefDistance(30),n.autoplay=!0,p.load("./JSON/R-shape.json",function(a){var i=new Physijs.BoxMesh(a,new THREE.MeshPhongMaterial({color:39168}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.add(n),n.load(ue[Math.floor(7*Math.random())]),i.name="brick",o.add(i)})},2e3)}function c(){setTimeout(function(){var e=ee*Math.floor(Math.random()*Q+1),t=ee*Math.floor(Math.random()*Q+1),n=new THREE.Audio(V);n.setRefDistance(30),n.autoplay=!0,p.load("./JSON/cube.json",function(a){var i=new Physijs.BoxMesh(a,new THREE.MeshPhongMaterial({color:128}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",n.load(ue[Math.floor(7*Math.random())]),o.add(i)})},2e3)}function u(){setTimeout(function(){var e=ee*Math.floor(Math.random()*Q+1),t=ee*Math.floor(Math.random()*Q+1),n=new THREE.Audio(V);n.setRefDistance(30),n.autoplay=!0,p.load("./JSON/squiggly.json",function(a){var i=new Physijs.BoxMesh(a,new THREE.MeshPhongMaterial({color:32896}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",n.load(ue[Math.floor(7*Math.random())]),o.add(i)})},2e3)}function m(){setTimeout(function(){var e=ee*Math.floor(Math.random()*Q+1),t=ee*Math.floor(Math.random()*Q+1),n=new THREE.Audio(V);n.setRefDistance(30),n.autoplay=!0,p.load("./JSON/pedestal.json",function(a){var i=new Physijs.BoxMesh(a,new THREE.MeshPhongMaterial({color:13789470}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",n.load(ue[Math.floor(7*Math.random())]),o.add(i)})},2e3)}function w(){setTimeout(function(){var e=ee*Math.floor(Math.random()*Q+1),t=ee*Math.floor(Math.random()*Q+1),n=new THREE.Audio(V);n.setRefDistance(30),n.autoplay=!0,p.load("./JSON/longline.json",function(a){var i=new Physijs.BoxMesh(a,new THREE.MeshPhongMaterial({color:8388608}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",n.load(ue[Math.floor(7*Math.random())]),o.add(i)})},2e3)}function y(){var e=new THREE.TextureLoader;g=new SPE.Group({texture:{value:e.load("../images/star1.png")},fog:!1,maxParticleCount:8e3}),R=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:4,position:{value:new THREE.Vector3(0,80,0),spread:new THREE.Vector3(2e3,30,2e3)},opacity:[.7],size:{value:[0,1,0]},particleCount:8e3,isStatic:!1}),g.addEmitter(R),o.add(g.mesh)}T=new THREE.Clock,n=new THREE.WebGLRenderer({antialias:!0}),n.setPixelRatio(window.devicePixelRatio),n.setSize(window.innerWidth,window.innerHeight),n.setClearColor(16777215),document.body.appendChild(n.domElement),o=new Physijs.Scene,o.setGravity(new THREE.Vector3(0,K,0)),Z=new Audio("../audio/bg.ogg"),Z.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=.5},!1),a=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),a.position.set(0,0,10),o.add(a),a.add(V),H=new THREE.PointerLockControls(a),o.add(H.getObject());var v=document.createElement("img");v.src="../images/crosshair.png",v["class"]="chair",v.style.position="absolute",document.body.appendChild(v),v.style.top=window.innerHeight/2+"px",v.style.left=window.innerWidth/2+"px";var k=document.createElement("div");k["class"]="hitcounter",k.style.position="absolute",k.style.top=window.innerHeight-50+"px",k.style.left=window.innerWidth/2+"px",k.style.color="#fff",k.style.fontFamily="Raleway",k.style.fontWeight="100",k.style.fontSize="2rem",document.body.appendChild(k),$(k).text(j),k.style.display="none";var b=document.createElement("div");b["class"]="levelcounter",b.style.position="absolute",b.style.top=window.innerHeight/2+"px",b.style.left=window.innerWidth/2+"px",b.style.color="#fff",b.style.width=window.innerWidth/3+"px",b.style.height=window.innerHeight/3+"px",b.style.marginLeft=-1*window.innerWidth/6+"px",b.style.marginTop=-1*window.innerHeight/1.4+"px",b.style.fontFamily="Raleway",b.style.fontWeight="100",b.style.fontSize="40rem",b.style.textAlign="center",b.style.color="#333",document.body.appendChild(b),$(b).text(z),$(b).hide();var S=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),B=!0;break;case 37:case 65:A=!0;break;case 40:case 83:C=!0;break;case 39:case 68:q=!0;break;case 32:F===!0&&(O.y+=200),F=!1}},W=function(e){switch(e.keyCode){case 38:case 87:B=!1;break;case 37:case 65:A=!1;break;case 40:case 83:C=!1;break;case 39:case 68:q=!1}};document.addEventListener("keydown",S,!1),document.addEventListener("keyup",W,!1),window.addEventListener("resize",i,!1),d=l=E=h=p=new THREE.JSONLoader;var D=setInterval(function(){function e(e){switch(e){case 1:s();break;case 2:c();break;case 3:u();break;case 4:m();break;case 5:w()}}var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),ae++,ae>=ie&&clearInterval(D)},re),G=13391189;f=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshLambertMaterial({color:G}),0),f.rotation.x=Math.PI,f.position.set(0,0,0),f.name="plane",f.addEventListener("collision",function(e){e.dead||(e.dead=!0,ne.push(e),te++),te>10&&console.log("death")}),o.add(f),r=new THREE.PointLight(16746632,.2),r.position.set(0,347,0),o.add(r);var I=new THREE.AmbientLight(16768477,.2);o.add(I),requestAnimationFrame(t);var J=new THREE.BoxGeometry(700,700,700),N=[],_=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0}));var _=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0}));var _=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:_.load("../images/top3.jpg"),side:THREE.BackSide,transparent:!0}));var _=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:_.load("../images/bottom3.jpg"),side:THREE.BackSide,transparent:!0}));var _=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0}));var _=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:_.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0}));var Y=new THREE.MeshFaceMaterial(N),X=new THREE.Mesh(J,Y);X.position.y=250,o.add(X),y();var U=new THREE.BokehPass(o,a,{focus:1,aperture:.09,maxblur:1.1,width:L,height:P});U.renderToScreen=!0,M=new THREE.EffectComposer(n),M.addPass(new THREE.RenderPass(o,a)),M.addPass(U),a.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){var t=new THREE.Vector2;t.x=0,t.y=0,x.setFromCamera(t,a);for(var n=x.intersectObjects(o.children),i=0;i<n.length;i++)if("plane"!=n[i].object.name&&"Points"!=n[i].object.type&&!n[i].object.dead&&(n[i].object.material.transparent=!0,oe.push(n[i].object),n[i].object.dead=!0,j++,$(k).text(j),j>=10*z)){z++,re-=400*z,Q+=50*z,K-=10,o.setGravity(new THREE.Vector3(0,K,0)),console.log("next up! Level "+z+", dropInterval: "+re,"dropRadius: "+Q+", gravity: "+K),te=0,e(z);for(var i=0;i<X.material.materials.length;i++)TweenLite.to(X.material.materials[i],5,{opacity:0})}},!1),e(z)},window.onerror=function(){return!0},t=function(){if(g.tick(T.getDelta()),S){var e=performance.now(),n=(e-W)/500;O.x-=10*O.x*n,O.z-=10*O.z*n,O.y-=9.8*100*n,B&&(O.z-=400*n),C&&(O.z+=400*n),A&&(O.x-=400*n),q&&(O.x+=400*n),H.getObject().translateX(O.x*n),H.getObject().translateY(O.y*n),H.getObject().translateZ(O.z*n),H.getObject().position.y<10&&(O.y=0,H.getObject().position.y=10),W=e}oe.length>0&&oe.forEach(function(e){e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.setLinearVelocity(new THREE.Vector3(0,0,0)),e.setAngularVelocity(new THREE.Vector3(0,0,0)),e.material.opacity=.5}),requestAnimationFrame(t),o.simulate(),M.render()},e()});