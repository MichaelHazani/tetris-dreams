$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,a,o,n,i,r,s,d,l,c,p,E,m,h,u,w,y,g,T,H,R,f,M,v,x,b,k,L,P=new THREE.Raycaster,j=new THREE.Vector2,B=window.innerWidth,S=window.innerHeight,z=0,C=1,A=!1,W=!1,F=!1,q=!1,O=!1,D=!1,V=performance.now(),G=new THREE.Vector3,I=new THREE.AudioListener,N,J,_,U,Y,X,Z,K,Q=new Audio("./audio/theme.ogg"),ee=new Audio("./audio/shepard.ogg"),te=-20,ae=100,oe=8,ne=0,ie=[],re=[],se=new THREE.LoadingManager,de,le=!1,ce=!1,pe,Ee=!0,me=0,he=500,ue=3e3,we="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(we){var ye=document.body,ge=function(e){document.pointerLockElement===ye||document.mozPointerLockElement===ye||document.webkitPointerLockElement===ye?(A=!0,b.enabled=!0):b.enabled=!1},Te=function(e){};document.addEventListener("pointerlockchange",ge,!1),document.addEventListener("mozpointerlockchange",ge,!1),document.addEventListener("webkitpointerlockchange",ge,!1),document.addEventListener("pointerlockerror",Te,!1),document.addEventListener("mozpointerlockerror",Te,!1),document.addEventListener("webkitpointerlockerror",Te,!1),document.body.addEventListener("click",function(e){if(ye.requestPointerLock=ye.requestPointerLock||ye.mozRequestPointerLock||ye.webkitRequestPointerLock,ye.exitPointerLock=ye.exitPointerLock||ye.mozExitPointerLock||ye.webkitExitPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===ye||document.mozFullscreenElement===ye||document.mozFullScreenElement===ye)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),ye.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),ye.requestFullscreen=ye.requestFullscreen||ye.mozRequestFullscreen||ye.mozRequestFullScreen||ye.webkitRequestFullscreen,ye.requestFullscreen()}else ye.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var He=["./audio/1.ogg","./audio/2.ogg","./audio/3.ogg","./audio/4.ogg","./audio/5.ogg","./audio/6.ogg","./audio/7.ogg","./audio/8.ogg"];e=function(){function i(e){$(V).text(e),$(V).fadeIn(3e3),$(V).fadeOut(1500)}function c(){n.aspect=window.innerWidth/window.innerHeight,n.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),j.style.top=window.innerHeight/2+"px",j.style.left=window.innerWidth/2+"px",A.style.top=window.innerHeight-50+"px",A.style.left=window.innerWidth/2+"px"}function E(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,T.load("./JSON/R-shape.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:39168,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.add(i),i.load(He[Math.floor(7*Math.random())]),t.name="brick",o.add(t)})},2e3)}function h(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,T.load("./JSON/cube.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:128,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(He[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function w(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,T.load("./JSON/squiggly.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:32896,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(He[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function g(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,T.load("./JSON/pedestal.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:13789470,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(He[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function H(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,T.load("./JSON/longline.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:8388608,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(He[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function x(){var e=new THREE.TextureLoader;f=new SPE.Group({texture:{value:e.load("./images/star1.png")},fog:!1,maxParticleCount:3e4}),M=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:4,position:{value:new THREE.Vector3(0,100,0),spread:new THREE.Vector3(1e3,30,1e3)},opacity:[.9],size:{value:[0,1,0]},particleCount:3e4,isStatic:!1}),f.addEmitter(M),o.add(f.mesh)}Q.removeEventListener("canplaythrough",e,!1),se.onProgress=function(e,t,a){console.log(e,t,a)},v=new THREE.Clock,a=new THREE.WebGLRenderer({antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(window.innerWidth,window.innerHeight),a.setClearColor(0),document.body.appendChild(a.domElement),o=new Physijs.Scene,o.setGravity(new THREE.Vector3(0,te,0)),Q.volume=1,ee.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=0},!1),ee.volume=0,ee.currentTime=30,n=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),n.position.set(0,0,10),o.add(n),n.add(I);var L=new THREE.Fog(16777215,1,1e3);b=new THREE.PointerLockControls(n),o.add(b.getObject());var j=document.createElement("img");j.src="./images/crosshair.png",j["class"]="chair",j.style.position="absolute",document.body.appendChild(j),j.style.top=window.innerHeight/2+"px",j.style.left=window.innerWidth/2+"px";var A=document.createElement("div");A["class"]="hitcounter",A.style.position="absolute",A.style.top=window.innerHeight-50+"px",A.style.left=window.innerWidth/2+"px",A.style.color="#fff",A.style.fontFamily="Raleway",A.style.fontWeight="100",A.style.fontSize="2rem",document.body.appendChild(A),$(A).text(z),A.style.display="none";var V=document.createElement("div");V["class"]="levelcounter",V.style.position="absolute",V.style.top=window.innerHeight/2+"px",V.style.left=window.innerWidth/2+"px",V.style.color="#fff",V.style.width=window.innerWidth/3+"px",V.style.height=window.innerHeight/3+"px",V.style.marginLeft=-1*window.innerWidth/6+"px",V.style.marginTop=-1*window.innerHeight/1.4+"px",V.style.fontFamily="Raleway",V.style.fontWeight="100",V.style.fontSize="40rem",V.style.textAlign="center",V.style.color="#333",document.body.appendChild(V),$(V).text(C),$(V).hide();var N=document.createElement("div");N["class"]="blackScreen",N.style.position="absolute",N.zIndex=134,N.style.top="0px",N.style.left="0px",N.style.backgroundColor="black",N.style.width=window.innerWidth+"px",N.style.height=window.innerHeight+"px",N.style.margin=0,N.style.color="white",N.style.opacity=0,N.style.textAlign="center";var J=document.createElement("div");J.innerHTML="<p class='p1d' style='opacity:0'>You almost made it.</p><p class='p2d' style='opacity:0'>Just one more level.</p><br><br><p class='p3d' style='opacity:0'>Try again?</p><p class='p4d' style='opacity:0'>I bet you'll beat it this time.</p><p class='p5d' style='opacity:0'>What's the harm?</p><div class='p5d' id='links' style='opacity: 0; width: 100%; position: absolute; float: right; bottom: 35px; line-height: 1em; font-size:0.7em; font-family:helvetica; color: #ccc'>&#169 2016 Michael Hazani <br> <a href='http://michaelhazani.com' alt='Michael Hazani's website' target='_blank' style='text-decoration:none; color:#ccc;'>website</a> | <a href='https://github.com/MichaelHazani/tetris-horror' alt='Hazani's Github' target='_blank' style='text-decoration:none; color:#ccc;'>GitHub</a></div>",J.style.fontSize="1em",J.style.textAlign="center",J.style.lineHeight="4rem",J.style.marginTop="2%",J.style.marginLeft="20px",J.style.position="absolute",J.style.top="0px",J.style.backgroundColor="black",J.style.color="white",J.style.width=window.innerWidth+"px",J.style.height=window.innerHeight+"px",N.appendChild(J);var _=document.createElement("div");_["class"]="introScreen",_.style.position="absolute",_.zIndex=134,_.style.top="0px",_.style.left="0px",_.style.backgroundColor="black",_.style.width=window.innerWidth+"px",_.style.height=window.innerHeight+"px",_.style.margin=0,_.style.color="white";var U=document.createElement("div");U.innerHTML="<div><p class='1p' style='opacity: 0'>\"...But nowadays, the populace at large isn't aware of our discoveries since we first encountered the Tetris Effect - <br>chronic, virtually irreversible phenomena such as neural hijacking, pattern-oriented compulsive obsessions or post-Pavlovian conditioning...</p><br><p class='2p' style='opacity: 0'>No one wants to be told about thousands of cases, women and men around the world <br> who spend their lives confined to padded cells, doomed to play a neverending game in their heads ad infinitum, <br> sans loved ones, sans thought, sans sleep...\" </p></div><br><br><span id='credits' class='3p' style='float:right; font-style: italic; margin-right:40px; opacity: 0'>A.L.Pajitnov, PhD, \"The Viral And The Virtual: Towards A New Pathology\"</span>",U.style.fontSize="1.1em",U.style.textAlign="left",U.style.lineHeight="4rem",U.style.marginTop="2%",U.style.marginLeft="20px",U.style.position="absolute",U.style.top="0px",U.style.backgroundColor="black",U.style.color="white",U.style.width=window.innerWidth+"px",U.style.height=window.innerHeight+"px",_.appendChild(U),ye.appendChild(_);var Y=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),W=!0;break;case 37:case 65:q=!0;break;case 40:case 83:F=!0;break;case 39:case 68:O=!0;break;case 32:D===!0&&(G.y+=200),D=!1;break;case 80:le=!le}},X=function(e){switch(e.keyCode){case 38:case 87:W=!1;break;case 37:case 65:q=!1;break;case 40:case 83:F=!1;break;case 39:case 68:O=!1}};document.addEventListener("keydown",Y,!1),document.addEventListener("keyup",X,!1),window.addEventListener("resize",c,!1),p=m=u=y=T=new THREE.JSONLoader,de=setInterval(function(){function e(e){switch(e){case 1:E();break;case 2:h();break;case 3:w();break;case 4:g();break;case 5:H()}}if(!le&&!ce&&!Ee){var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),me++,me>=he&&clearInterval(de)}},ue),pe=function(e){ce=!0,document.exitPointerLock(),$(ee).animate({volume:0},2e3),ye.appendChild(N),$(N).animate({opacity:1},2e3),$(".p1d").animate({opacity:1},1e4),$(".p2d").animate({opacity:1},2e4),$(".p3d").animate({opacity:1},3e4),$(".p4d").animate({opacity:1},5e4),$(".p5d").animate({opacity:1},6e4),setTimeout(function(){window.addEventListener("mousedown",function(){location.reload()})},1e4)};var Z=10770263;R=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshPhongMaterial({color:Z}),0),R.rotation.x=Math.PI,R.position.set(0,0,0),R.name="plane",R.addEventListener("collision",function(e){e.dead||(e.dead=!0,ie.push(e),ne++),ne>11-2*C&&pe(C)}),o.add(R),r=new THREE.PointLight(16777215,.5),r.position.set(150,200,150),o.add(r),s=new THREE.PointLight(16777215,.5),s.position.set(150,200,-150),o.add(s),d=new THREE.PointLight(16777215,.5),d.position.set(-150,200,150),o.add(d),l=new THREE.PointLight(16777215,.5),l.position.set(-150,200,-150),o.add(l),requestAnimationFrame(t);var K=new THREE.BoxGeometry(700,700,700),oe=[],we=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var we=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var we=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:we.load("./images/top1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var we=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:we.load("./images/bottom1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var we=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var we=new THREE.TextureLoader;oe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var ge=new THREE.MeshFaceMaterial(oe),Te=new THREE.Mesh(K,ge);Te.position.y=250,o.add(Te);var Re=new THREE.BoxGeometry(740,740,740),fe=[],we=new THREE.TextureLoader;fe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;fe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;fe.push(new THREE.MeshBasicMaterial({map:we.load("./images/top2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;fe.push(new THREE.MeshBasicMaterial({map:we.load("./images/bottom2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;fe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;fe.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Me=new THREE.MeshFaceMaterial(fe),ve=new THREE.Mesh(Re,Me);ve.position.y=245,o.add(ve);var xe=new THREE.BoxGeometry(720,720,720),be=[],we=new THREE.TextureLoader;be.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;be.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;be.push(new THREE.MeshBasicMaterial({map:we.load("./images/top3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;be.push(new THREE.MeshBasicMaterial({map:we.load("./images/bottom3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;be.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;be.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ke=new THREE.MeshFaceMaterial(be),Le=new THREE.Mesh(xe,ke);Le.position.y=245,o.add(Le);var Pe=new THREE.BoxGeometry(760,760,760),je=[],we=new THREE.TextureLoader;je.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;je.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;je.push(new THREE.MeshBasicMaterial({map:we.load("./images/top4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;je.push(new THREE.MeshBasicMaterial({map:we.load("./images/bottom4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;je.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var we=new THREE.TextureLoader;je.push(new THREE.MeshBasicMaterial({map:we.load("./images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Be=new THREE.MeshFaceMaterial(je),Se=new THREE.Mesh(Pe,Be);Se.position.y=245,o.add(Se),x();var ze=new THREE.BokehPass(o,n,{focus:1,aperture:.02,maxblur:1.02,width:B,height:S});ze.renderToScreen=!0,k=new THREE.EffectComposer(a),k.addPass(new THREE.RenderPass(o,n)),k.addPass(ze),n.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){function e(){o.remove(Te),R.material.color=new THREE.Color(16711935);for(var e=0;e<Le.material.materials.length;e++)TweenLite.to(Le.material.materials[e],3,{opacity:1})}function t(){o.remove(Le),R.material.color=new THREE.Color(8650815);for(var e=0;e<ve.material.materials.length;e++)TweenLite.to(ve.material.materials[e],3,{opacity:1})}function a(){o.remove(ve),R.material.color=new THREE.Color(4544102);for(var e=0;e<Se.material.materials.length;e++)TweenLite.to(Se.material.materials[e],3,{opacity:1})}var i=new THREE.Vector2;i.x=0,i.y=0,P.setFromCamera(i,n);for(var r=P.intersectObjects(o.children),s=0;s<r.length;s++)if("plane"==r[s].object.name||"Points"==r[s].object.type||r[s].object.dead||(r[s].object.material.wireframe=!0,r[s].object.dead=!0,re.push(r[s].object),z++,$(A).text(z)),z>=10*C){ue-=600*C,ae+=45*C,te-=40,o.setGravity(new THREE.Vector3(0,te,0)),ne=0;for(var s=0;s<ie.length;s++)o.remove(ie[s]);switch(C){case 1:for(var s=0;s<Te.material.materials.length;s++)TweenLite.to(Te.material.materials[s],5,{opacity:0,onComplete:e});break;case 2:for(var s=0;s<Le.material.materials.length;s++)TweenLite.to(Le.material.materials[s],5,{opacity:0,onComplete:t});break;case 3:for(var s=0;s<ve.material.materials.length;s++)TweenLite.to(ve.material.materials[s],5,{opacity:0,onComplete:a})}C++}},!1),$(".1p").animate({opacity:1},1e4),$(".2p").animate({opacity:1},3e4),$(".3p").animate({opacity:1},6e4),Q.play(),$(_).click(function(){$(Q).animate({volume:0},1e3),setTimeout(function(){Q.stop()},1500),$(ee).animate({volume:.5},6e3),$(_).fadeOut(2e3),setTimeout(function(){ye.removeChild(_)},2e3),Ee=!1})},window.onerror=function(){return!0},t=function(){if(f.tick(v.getDelta()),A){var e=performance.now(),a=(e-V)/500;G.x-=10*G.x*a,G.z-=10*G.z*a,G.y-=9.8*100*a,W&&(G.z-=400*a),F&&(G.z+=400*a),q&&(G.x-=400*a),O&&(G.x+=400*a),b.getObject().translateX(G.x*a),b.getObject().translateY(G.y*a),b.getObject().translateZ(G.z*a),b.getObject().position.y<10&&(G.y=0,b.getObject().position.y=10),V=e}re.length>0&&re.forEach(function(e){e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.setLinearVelocity(new THREE.Vector3(0,1.5,0)),e.setAngularVelocity(new THREE.Vector3(0,.2,0))}),requestAnimationFrame(t),le?(ee.pause(),document.exitPointerLock()):(we||document.requestPointerLock(),ee.play(),o.simulate(),k.render())},Q.addEventListener("canplaythrough",e,!1)});