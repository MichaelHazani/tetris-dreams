"use strict";$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,a,o,n,i,r,s,d,l,c,E,p,m,u,h,w,T,g,R,H,y,M,f,v,x,k,L,b,j=new THREE.Raycaster,P=new THREE.Vector2,B=window.innerWidth,S=window.innerHeight,z=0,C=1,A=!1,F=!1,q=!1,W=!1,O=!1,D=!1,V=performance.now(),G=new THREE.Vector3,I=new THREE.AudioListener,U,J,N,_,Y,X,Z,K,Q,ee,te=-20,ae=100,oe=8,ne=0,ie=[],re=[],se=new THREE.LoadingManager,de,le=!1,ce=!1,Ee=0,pe=500,me=3e3,ue="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(ue){var he=document.body,we=function(e){document.pointerLockElement===he||document.mozPointerLockElement===he||document.webkitPointerLockElement===he?(A=!0,k.enabled=!0):k.enabled=!1},Te=function(e){};document.addEventListener("pointerlockchange",we,!1),document.addEventListener("mozpointerlockchange",we,!1),document.addEventListener("webkitpointerlockchange",we,!1),document.addEventListener("pointerlockerror",Te,!1),document.addEventListener("mozpointerlockerror",Te,!1),document.addEventListener("webkitpointerlockerror",Te,!1),document.body.addEventListener("click",function(e){if(he.requestPointerLock=he.requestPointerLock||he.mozRequestPointerLock||he.webkitRequestPointerLock,he.exitPointerLock=he.exitPointerLock||he.mozExitPointerLock||he.webkitExitPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===he||document.mozFullscreenElement===he||document.mozFullScreenElement===he)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),he.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),he.requestFullscreen=he.requestFullscreen||he.mozRequestFullscreen||he.mozRequestFullScreen||he.webkitRequestFullscreen,he.requestFullscreen()}else he.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var ge=["../audio/1.ogg","../audio/2.ogg","../audio/3.ogg","../audio/4.ogg","../audio/5.ogg","../audio/6.ogg","../audio/7.ogg","../audio/8.ogg"];e=function(){function e(e){$(A).text(e),$(A).fadeIn(3e3),$(A).fadeOut(1500)}function i(){n.aspect=window.innerWidth/window.innerHeight,n.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),b.style.top=window.innerHeight/2+"px",b.style.left=window.innerWidth/2+"px",P.style.top=window.innerHeight-50+"px",P.style.left=window.innerWidth/2+"px"}function c(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,R.load("./JSON/R-shape.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:39168,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.add(i),i.load(ge[Math.floor(7*Math.random())]),t.name="brick",o.add(t)})},2e3)}function p(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,R.load("./JSON/cube.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:128,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function u(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,R.load("./JSON/squiggly.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:32896,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function w(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,R.load("./JSON/pedestal.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:13789470,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function g(){setTimeout(function(){var e=2*Math.round(Math.random())-1,t=2*Math.round(Math.random())-1,a=e*Math.floor(Math.random()*ae+1),n=t*Math.floor(Math.random()*ae+1),i=new THREE.Audio(I);i.setRefDistance(30),i.autoplay=!0,R.load("./JSON/longline.json",function(e){var t=new Physijs.BoxMesh(e,new THREE.MeshPhongMaterial({color:8388608,wireframe:!1}));t.scale.set(2,2,2),t.position.y=100,t.position.x=a,t.position.z=n,t.rotation.x=a,t.rotation.y=n,t.rotation.z=a,t.name="brick",i.load(ge[Math.floor(7*Math.random())]),o.add(t)})},2e3)}function H(){var e=new THREE.TextureLoader;M=new SPE.Group({texture:{value:e.load("../images/star1.png")},fog:!1,maxParticleCount:3e4}),f=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:4,position:{value:new THREE.Vector3(0,100,0),spread:new THREE.Vector3(1e3,30,1e3)},opacity:[.9],size:{value:[0,1,0]},particleCount:3e4,isStatic:!1}),M.addEmitter(f),o.add(M.mesh)}se.onProgress=function(e,t,a){console.log(e,t,a)},v=new THREE.Clock,a=new THREE.WebGLRenderer({antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(window.innerWidth,window.innerHeight),a.setClearColor(0),document.body.appendChild(a.domElement),o=new Physijs.Scene,o.setGravity(new THREE.Vector3(0,te,0)),Q=new Audio("../audio/theme.ogg"),Q.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=.05},!1),Q.volume=.5,ee=new Audio("../audio/shepard.ogg"),ee.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=0},!1),ee.volume=0,ee.currentTime=30,$(ee).animate({volume:.5},6e3),n=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),n.position.set(0,0,10),o.add(n),n.add(I);var x=new THREE.Fog(16777215,1,1e3);k=new THREE.PointerLockControls(n),o.add(k.getObject());var b=document.createElement("img");b.src="../images/crosshair.png",b["class"]="chair",b.style.position="absolute",document.body.appendChild(b),b.style.top=window.innerHeight/2+"px",b.style.left=window.innerWidth/2+"px";var P=document.createElement("div");P["class"]="hitcounter",P.style.position="absolute",P.style.top=window.innerHeight-50+"px",P.style.left=window.innerWidth/2+"px",P.style.color="#fff",P.style.fontFamily="Raleway",P.style.fontWeight="100",P.style.fontSize="2rem",document.body.appendChild(P),$(P).text(z),P.style.display="none";var A=document.createElement("div");A["class"]="levelcounter",A.style.position="absolute",A.style.top=window.innerHeight/2+"px",A.style.left=window.innerWidth/2+"px",A.style.color="#fff",A.style.width=window.innerWidth/3+"px",A.style.height=window.innerHeight/3+"px",A.style.marginLeft=-1*window.innerWidth/6+"px",A.style.marginTop=-1*window.innerHeight/1.4+"px",A.style.fontFamily="Raleway",A.style.fontWeight="100",A.style.fontSize="40rem",A.style.textAlign="center",A.style.color="#333",document.body.appendChild(A),$(A).text(C),$(A).hide();var V=document.createElement("div");V["class"]="deathmask",V.style.position="absolute",V.zIndex=134,V.style.top="0px",V.style.left="0px",V.style.backgroundColor="black",V.style.width=window.innerWidth+"px",V.style.height=window.innerHeight+"px",V.style.margin=0,V.style.color="white",V.style.textAlign="center",V.innerHTML="Awakening Awaits Us All.",he.appendChild(V),$(V).hide();var U=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),F=!0;break;case 37:case 65:W=!0;break;case 40:case 83:q=!0;break;case 39:case 68:O=!0;break;case 32:D===!0&&(G.y+=200),D=!1;break;case 80:le=!le}},J=function(e){switch(e.keyCode){case 38:case 87:F=!1;break;case 37:case 65:W=!1;break;case 40:case 83:q=!1;break;case 39:case 68:O=!1}};document.addEventListener("keydown",U,!1),document.addEventListener("keyup",J,!1),window.addEventListener("resize",i,!1),E=m=h=T=R=new THREE.JSONLoader,de=setInterval(function(){function e(e){switch(e){case 1:c();break;case 2:p();break;case 3:u();break;case 4:w();break;case 5:g()}}if(!le&&!ce){var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),Ee++,Ee>=pe&&clearInterval(de)}},me);var N=function(e){ce=!0,$(V).fadeIn(2e3),console.log("you died"),$(ee).animate({volume:0},2e3),Q.play()},_=10770263;y=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshPhongMaterial({color:_}),0),y.rotation.x=Math.PI,y.position.set(0,0,0),y.name="plane",y.addEventListener("collision",function(e){e.dead||(e.dead=!0,ie.push(e),ne++),ne>11-2*C&&(console.log("death"),N(C))}),o.add(y),r=new THREE.PointLight(16777215,.5),r.position.set(150,200,150),o.add(r),s=new THREE.PointLight(16777215,.5),s.position.set(150,200,-150),o.add(s),d=new THREE.PointLight(16777215,.5),d.position.set(-150,200,150),o.add(d),l=new THREE.PointLight(16777215,.5),l.position.set(-150,200,-150),o.add(l),requestAnimationFrame(t);var Y=new THREE.BoxGeometry(700,700,700),X=[],Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/top1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/bottom1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var Z=new THREE.TextureLoader;X.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var K=new THREE.MeshFaceMaterial(X),oe=new THREE.Mesh(Y,K);oe.position.y=250,o.add(oe);var ue=new THREE.BoxGeometry(740,740,740),we=[],Z=new THREE.TextureLoader;we.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;we.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;we.push(new THREE.MeshBasicMaterial({map:Z.load("../images/top2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;we.push(new THREE.MeshBasicMaterial({map:Z.load("../images/bottom2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;we.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;we.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Te=new THREE.MeshFaceMaterial(we),Re=new THREE.Mesh(ue,Te);Re.position.y=245,o.add(Re);var He=new THREE.BoxGeometry(720,720,720),ye=[],Z=new THREE.TextureLoader;ye.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;ye.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;ye.push(new THREE.MeshBasicMaterial({map:Z.load("../images/top3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;ye.push(new THREE.MeshBasicMaterial({map:Z.load("../images/bottom3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;ye.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;ye.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Me=new THREE.MeshFaceMaterial(ye),fe=new THREE.Mesh(He,Me);fe.position.y=245,o.add(fe);var ve=new THREE.BoxGeometry(760,760,760),xe=[],Z=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:Z.load("../images/top4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:Z.load("../images/bottom4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Z=new THREE.TextureLoader;xe.push(new THREE.MeshBasicMaterial({map:Z.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ke=new THREE.MeshFaceMaterial(xe),Le=new THREE.Mesh(ve,ke);Le.position.y=245,o.add(Le),H();var be=new THREE.BokehPass(o,n,{focus:1,aperture:.06,maxblur:1.05,width:B,height:S});be.renderToScreen=!0,L=new THREE.EffectComposer(a),L.addPass(new THREE.RenderPass(o,n)),L.addPass(be),n.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){function e(){o.remove(oe),y.material.color=new THREE.Color(16711935);for(var e=0;e<fe.material.materials.length;e++)TweenLite.to(fe.material.materials[e],3,{opacity:1})}function t(){o.remove(fe),y.material.color=new THREE.Color(8650815);for(var e=0;e<Re.material.materials.length;e++)TweenLite.to(Re.material.materials[e],3,{opacity:1})}function a(){o.remove(Re),y.material.color=new THREE.Color(4544102);for(var e=0;e<Le.material.materials.length;e++)TweenLite.to(Le.material.materials[e],3,{opacity:1})}var i=new THREE.Vector2;i.x=0,i.y=0,j.setFromCamera(i,n);for(var r=j.intersectObjects(o.children),s=0;s<r.length;s++)if("plane"==r[s].object.name||"Points"==r[s].object.type||r[s].object.dead||(r[s].object.material.wireframe=!0,r[s].object.dead=!0,re.push(r[s].object),z++,$(P).text(z)),z>=10*C){me-=600*C,ae+=45*C,te-=40,o.setGravity(new THREE.Vector3(0,te,0)),console.log("next up! Level "+C+", dropInterval: "+me,"dropRadius: "+ae+", gravity: "+te),ne=0;for(var s=0;s<ie.length;s++)o.remove(ie[s]);switch(C){case 1:for(var s=0;s<oe.material.materials.length;s++)TweenLite.to(oe.material.materials[s],5,{opacity:0,onComplete:e});break;case 2:for(var s=0;s<fe.material.materials.length;s++)TweenLite.to(fe.material.materials[s],5,{opacity:0,onComplete:t});break;case 3:for(var s=0;s<Re.material.materials.length;s++)TweenLite.to(Re.material.materials[s],5,{opacity:0,onComplete:a})}C++}},!1)},window.onerror=function(){return!0},t=function(){if(M.tick(v.getDelta()),A){var e=performance.now(),i=(e-V)/500;G.x-=10*G.x*i,G.z-=10*G.z*i,G.y-=9.8*100*i,F&&(G.z-=400*i),q&&(G.z+=400*i),W&&(G.x-=400*i),O&&(G.x+=400*i),k.getObject().translateX(G.x*i),k.getObject().translateY(G.y*i),k.getObject().translateZ(G.z*i),k.getObject().position.y<10&&(G.y=0,k.getObject().position.y=10),V=e}re.length>0&&re.forEach(function(e){e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.setLinearVelocity(new THREE.Vector3(0,1.5,0)),e.setAngularVelocity(new THREE.Vector3(0,.2,0))}),requestAnimationFrame(t),le?(ee.pause(),document.exitPointerLock()):(ue||document.requestPointerLock(),ee.play(),o.simulate(),a.render(o,n))},e()});