"use strict";$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,a,n,o,i,r,s,d,c,l,E,p,u,m,h,w,T,g,R,H,y,M,f,v,x,k=new THREE.Raycaster,L=new THREE.Vector2,b=window.innerWidth,j=window.innerHeight,B=0,P=1,S=!1,z=!1,C=!1,F=!1,A=!1,q=!1,W=performance.now(),O=new THREE.Vector3,D=new THREE.AudioListener,V,G,I,J,N,U,_,Y,X,Z,K=-20,Q=100,ee=8,te=2*Math.round(Math.random())-1,ae=0,ne=[],oe=[],ie=new THREE.LoadingManager,re=0,se=500,de=3e3,ce="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(ce){var le=document.body,Ee=function(e){document.pointerLockElement===le||document.mozPointerLockElement===le||document.webkitPointerLockElement===le?(S=!0,f.enabled=!0):f.enabled=!1},pe=function(e){};document.addEventListener("pointerlockchange",Ee,!1),document.addEventListener("mozpointerlockchange",Ee,!1),document.addEventListener("webkitpointerlockchange",Ee,!1),document.addEventListener("pointerlockerror",pe,!1),document.addEventListener("mozpointerlockerror",pe,!1),document.addEventListener("webkitpointerlockerror",pe,!1),document.body.addEventListener("click",function(e){if(le.requestPointerLock=le.requestPointerLock||le.mozRequestPointerLock||le.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===le||document.mozFullscreenElement===le||document.mozFullScreenElement===le)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),le.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),le.requestFullscreen=le.requestFullscreen||le.mozRequestFullscreen||le.mozRequestFullScreen||le.webkitRequestFullscreen,le.requestFullscreen()}else le.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var ue=["../audio/1.ogg","../audio/2.ogg","../audio/3.ogg","../audio/4.ogg","../audio/5.ogg","../audio/6.ogg","../audio/7.ogg","../audio/8.ogg"];e=function(){function e(e){$(S).text(e),$(S).fadeIn(3e3),$(S).fadeOut(1500)}function i(){o.aspect=window.innerWidth/window.innerHeight,o.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),x.style.top=window.innerHeight/2+"px",x.style.left=window.innerWidth/2+"px",L.style.top=window.innerHeight-50+"px",L.style.left=window.innerWidth/2+"px"}function s(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/R-shape.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:39168,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.add(a),a.load(ue[Math.floor(7*Math.random())]),i.name="brick",n.add(i)})},2e3)}function c(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/cube.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:128,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(ue[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function E(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/squiggly.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:32896,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(ue[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function u(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/pedestal.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:13789470,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(ue[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function h(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/longline.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:8388608,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(ue[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function T(){var e=new THREE.TextureLoader;R=new SPE.Group({texture:{value:e.load("../images/star1.png")},fog:!1,maxParticleCount:3e4}),H=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:4,position:{value:new THREE.Vector3(0,100,0),spread:new THREE.Vector3(1e3,30,1e3)},opacity:[.9],size:{value:[0,1,0]},particleCount:3e4,isStatic:!1}),R.addEmitter(H),n.add(R.mesh)}ie.onProgress=function(e,t,a){console.log(e,t,a)},y=new THREE.Clock,a=new THREE.WebGLRenderer({antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(window.innerWidth,window.innerHeight),a.setClearColor(0),document.body.appendChild(a.domElement),n=new Physijs.Scene,n.setGravity(new THREE.Vector3(0,K,0)),X=new Audio("../audio/bg.ogg"),X.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=.3},!1),X.play(),Z=new Audio("../audio/shepard.ogg"),Z.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=.05},!1),Z.currentTime=70,Z.play(),o=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),o.position.set(0,0,10),n.add(o),o.add(D);var M=new THREE.Fog(16777215,1,1e3);f=new THREE.PointerLockControls(o),n.add(f.getObject());var x=document.createElement("img");x.src="../images/crosshair.png",x["class"]="chair",x.style.position="absolute",document.body.appendChild(x),x.style.top=window.innerHeight/2+"px",x.style.left=window.innerWidth/2+"px";var L=document.createElement("div");L["class"]="hitcounter",L.style.position="absolute",L.style.top=window.innerHeight-50+"px",L.style.left=window.innerWidth/2+"px",L.style.color="#fff",L.style.fontFamily="Raleway",L.style.fontWeight="100",L.style.fontSize="2rem",document.body.appendChild(L),$(L).text(B),L.style.display="none";var S=document.createElement("div");S["class"]="levelcounter",S.style.position="absolute",S.style.top=window.innerHeight/2+"px",S.style.left=window.innerWidth/2+"px",S.style.color="#fff",S.style.width=window.innerWidth/3+"px",S.style.height=window.innerHeight/3+"px",S.style.marginLeft=-1*window.innerWidth/6+"px",S.style.marginTop=-1*window.innerHeight/1.4+"px",S.style.fontFamily="Raleway",S.style.fontWeight="100",S.style.fontSize="40rem",S.style.textAlign="center",S.style.color="#333",document.body.appendChild(S),$(S).text(P),$(S).hide();var W=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),z=!0;break;case 37:case 65:F=!0;break;case 40:case 83:C=!0;break;case 39:case 68:A=!0;break;case 32:q===!0&&(O.y+=200),q=!1}},V=function(e){switch(e.keyCode){case 38:case 87:z=!1;break;case 37:case 65:F=!1;break;case 40:case 83:C=!1;break;case 39:case 68:A=!1}};document.addEventListener("keydown",W,!1),document.addEventListener("keyup",V,!1),window.addEventListener("resize",i,!1),d=l=p=m=w=new THREE.JSONLoader;var G=setInterval(function(){function e(e){switch(e){case 1:s();break;case 2:c();break;case 3:E();break;case 4:u();break;case 5:h()}}var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),re++,re>=se&&clearInterval(G)},de),I=1118481;g=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshLambertMaterial({color:I}),0),g.rotation.x=Math.PI,g.position.set(0,0,0),g.name="plane",g.addEventListener("collision",function(e){e.dead||(e.dead=!0,ne.push(e),ae++),ae>10&&console.log("death")}),n.add(g),r=new THREE.PointLight(16777215,1),r.position.set(0,200,0),n.add(r),requestAnimationFrame(t);var J=new THREE.BoxGeometry(700,700,700),N=[],U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/top1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var _=new THREE.MeshFaceMaterial(N),Y=new THREE.Mesh(J,_);Y.position.y=250,n.add(Y);var ee=new THREE.BoxGeometry(740,740,740),ce=[],U=new THREE.TextureLoader;ce.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ce.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ce.push(new THREE.MeshBasicMaterial({map:U.load("../images/top2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ce.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ce.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ce.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var le=new THREE.MeshFaceMaterial(ce),Ee=new THREE.Mesh(ee,le);Ee.position.y=245,n.add(Ee);var pe=new THREE.BoxGeometry(720,720,720),me=[],U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/top3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var he=new THREE.MeshFaceMaterial(me),we=new THREE.Mesh(pe,he);we.position.y=245,n.add(we);var Te=new THREE.BoxGeometry(760,760,760),ge=[],U=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:U.load("../images/top4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;ge.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Re=new THREE.MeshFaceMaterial(ge),He=new THREE.Mesh(Te,Re);He.position.y=245,n.add(He),T();var ye=new THREE.BokehPass(n,o,{focus:1,aperture:.06,maxblur:1.05,width:b,height:j});ye.renderToScreen=!0,v=new THREE.EffectComposer(a),v.addPass(new THREE.RenderPass(n,o)),v.addPass(ye),o.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){function e(){console.log(P),n.remove(Y);for(var e=0;e<we.material.materials.length;e++)TweenLite.to(we.material.materials[e],3,{opacity:1})}function t(){console.log(P),n.remove(we);for(var e=0;e<Ee.material.materials.length;e++)TweenLite.to(Ee.material.materials[e],3,{opacity:1})}function a(){console.log(P),n.remove(Ee);for(var e=0;e<He.material.materials.length;e++)TweenLite.to(He.material.materials[e],3,{opacity:1})}var i=new THREE.Vector2;i.x=0,i.y=0,k.setFromCamera(i,o);for(var r=k.intersectObjects(n.children),s=0;s<r.length;s++)if("plane"==r[s].object.name||"Points"==r[s].object.type||r[s].object.dead||(r[s].object.material.wireframe=!0,r[s].object.dead=!0,oe.push(r[s].object),B++,$(L).text(B)),B>=10*P){de-=400*P,Q+=30*P,K-=30,n.setGravity(new THREE.Vector3(0,K,0)),console.log("next up! Level "+P+", dropInterval: "+de,"dropRadius: "+Q+", gravity: "+K),ae=0,console.log(ne);for(var s=0;s<ne.length;s++)console.log(ne[s]),n.remove(ne[s]);switch(P){case 1:for(var s=0;s<Y.material.materials.length;s++)TweenLite.to(Y.material.materials[s],5,{opacity:0,onComplete:e});break;case 2:for(var s=0;s<we.material.materials.length;s++)TweenLite.to(we.material.materials[s],5,{opacity:0,onComplete:t});break;case 3:for(var s=0;s<Ee.material.materials.length;s++)TweenLite.to(Ee.material.materials[s],5,{opacity:0,onComplete:a})}P++}},!1),e(P)},window.onerror=function(){return!0},t=function(){if(R.tick(y.getDelta()),S){var e=performance.now(),i=(e-W)/500;O.x-=10*O.x*i,O.z-=10*O.z*i,O.y-=9.8*100*i,z&&(O.z-=400*i),C&&(O.z+=400*i),F&&(O.x-=400*i),A&&(O.x+=400*i),f.getObject().translateX(O.x*i),f.getObject().translateY(O.y*i),f.getObject().translateZ(O.z*i),f.getObject().position.y<10&&(O.y=0,f.getObject().position.y=10),W=e}oe.length>0&&oe.forEach(function(e){e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.setLinearVelocity(new THREE.Vector3(0,1.5,0)),e.setAngularVelocity(new THREE.Vector3(0,.2,0))}),requestAnimationFrame(t),n.simulate(),a.render(n,o)},e()});