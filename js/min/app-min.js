"use strict";$(function(){Physijs.scripts.worker="./js/physijs_worker.js",Physijs.scripts.ammo="./ammo.js";var e,t,a,n,o,i,r,s,d,c,l,E,p,m,u,h,w,T,R,g,H,y,M,f,v,x,k=new THREE.Raycaster,L=new THREE.Vector2,b=window.innerWidth,j=window.innerHeight,B=0,P=1,S=!1,z=!1,C=!1,F=!1,A=!1,q=!1,W=performance.now(),O=new THREE.Vector3,D=new THREE.AudioListener,V,G,I,J,N,U,_,Y,X,Z,K=-20,Q=100,ee=8,te=2*Math.round(Math.random())-1,ae=0,ne=[],oe=[],ie=0,re=500,se=3e3,de="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(de){var ce=document.body,le=function(e){document.pointerLockElement===ce||document.mozPointerLockElement===ce||document.webkitPointerLockElement===ce?(S=!0,f.enabled=!0):f.enabled=!1},Ee=function(e){};document.addEventListener("pointerlockchange",le,!1),document.addEventListener("mozpointerlockchange",le,!1),document.addEventListener("webkitpointerlockchange",le,!1),document.addEventListener("pointerlockerror",Ee,!1),document.addEventListener("mozpointerlockerror",Ee,!1),document.addEventListener("webkitpointerlockerror",Ee,!1),document.body.addEventListener("click",function(e){if(ce.requestPointerLock=ce.requestPointerLock||ce.mozRequestPointerLock||ce.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var t=function(e){(document.fullscreenElement===ce||document.mozFullscreenElement===ce||document.mozFullScreenElement===ce)&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),ce.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),ce.requestFullscreen=ce.requestFullscreen||ce.mozRequestFullscreen||ce.mozRequestFullScreen||ce.webkitRequestFullscreen,ce.requestFullscreen()}else ce.requestPointerLock()},!1)}else document.body.innerHTML="Your browser doesn't seem to support Pointer Lock API";var pe=["../audio/1.ogg","../audio/2.ogg","../audio/3.ogg","../audio/4.ogg","../audio/5.ogg","../audio/6.ogg","../audio/7.ogg","../audio/8.ogg"];e=function(){function e(e){$(S).text(e),$(S).fadeIn(3e3),$(S).fadeOut(1500)}function i(){o.aspect=window.innerWidth/window.innerHeight,o.updateProjectionMatrix(),a.setSize(window.innerWidth,window.innerHeight),x.style.top=window.innerHeight/2+"px",x.style.left=window.innerWidth/2+"px",L.style.top=window.innerHeight-50+"px",L.style.left=window.innerWidth/2+"px"}function s(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/R-shape.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:39168,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.add(a),a.load(pe[Math.floor(7*Math.random())]),i.name="brick",n.add(i)})},2e3)}function c(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/cube.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:128,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(pe[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function E(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/squiggly.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:32896,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(pe[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function m(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/pedestal.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:13789470,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(pe[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function h(){setTimeout(function(){var e=te*Math.floor(Math.random()*Q+1),t=te*Math.floor(Math.random()*Q+1),a=new THREE.Audio(D);a.setRefDistance(30),a.autoplay=!0,w.load("./JSON/longline.json",function(o){var i=new Physijs.BoxMesh(o,new THREE.MeshPhongMaterial({color:8388608,wireframe:!1}));i.scale.set(2,2,2),i.position.y=100,i.position.x=e,i.position.z=t,i.rotation.x=e,i.rotation.y=t,i.rotation.z=e,i.name="brick",a.load(pe[Math.floor(7*Math.random())]),n.add(i)})},2e3)}function T(){var e=new THREE.TextureLoader;g=new SPE.Group({texture:{value:e.load("../images/star1.png")},fog:!1,maxParticleCount:3e4}),H=new SPE.Emitter({type:SPE.distributions.SPHERE,maxAge:4,position:{value:new THREE.Vector3(0,100,0),spread:new THREE.Vector3(1e3,30,1e3)},opacity:[.9],size:{value:[0,1,0]},particleCount:3e4,isStatic:!1}),g.addEmitter(H),n.add(g.mesh)}y=new THREE.Clock,a=new THREE.WebGLRenderer({antialias:!0}),a.setPixelRatio(window.devicePixelRatio),a.setSize(window.innerWidth,window.innerHeight),a.setClearColor(0),document.body.appendChild(a.domElement),n=new Physijs.Scene,n.setGravity(new THREE.Vector3(0,K,0)),X=new Audio("../audio/bg.ogg"),X.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=.3},!1),X.play(),Z=new Audio("../audio/shepard.ogg"),Z.addEventListener("ended",function(){this.currentTime=0,this.play(),this.volume=.05},!1),Z.currentTime=70,Z.play(),o=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,1e3),o.position.set(0,0,10),n.add(o),o.add(D);var M=new THREE.Fog(16777215,1,1e3);f=new THREE.PointerLockControls(o),n.add(f.getObject());var x=document.createElement("img");x.src="../images/crosshair.png",x["class"]="chair",x.style.position="absolute",document.body.appendChild(x),x.style.top=window.innerHeight/2+"px",x.style.left=window.innerWidth/2+"px";var L=document.createElement("div");L["class"]="hitcounter",L.style.position="absolute",L.style.top=window.innerHeight-50+"px",L.style.left=window.innerWidth/2+"px",L.style.color="#fff",L.style.fontFamily="Raleway",L.style.fontWeight="100",L.style.fontSize="2rem",document.body.appendChild(L),$(L).text(B),L.style.display="none";var S=document.createElement("div");S["class"]="levelcounter",S.style.position="absolute",S.style.top=window.innerHeight/2+"px",S.style.left=window.innerWidth/2+"px",S.style.color="#fff",S.style.width=window.innerWidth/3+"px",S.style.height=window.innerHeight/3+"px",S.style.marginLeft=-1*window.innerWidth/6+"px",S.style.marginTop=-1*window.innerHeight/1.4+"px",S.style.fontFamily="Raleway",S.style.fontWeight="100",S.style.fontSize="40rem",S.style.textAlign="center",S.style.color="#333",document.body.appendChild(S),$(S).text(P),$(S).hide();var W=function(e){switch(e.keyCode){case 38:case 87:e.preventDefault(),z=!0;break;case 37:case 65:F=!0;break;case 40:case 83:C=!0;break;case 39:case 68:A=!0;break;case 32:q===!0&&(O.y+=200),q=!1}},V=function(e){switch(e.keyCode){case 38:case 87:z=!1;break;case 37:case 65:F=!1;break;case 40:case 83:C=!1;break;case 39:case 68:A=!1}};document.addEventListener("keydown",W,!1),document.addEventListener("keyup",V,!1),window.addEventListener("resize",i,!1),d=l=p=u=w=new THREE.JSONLoader;var G=setInterval(function(){function e(e){switch(e){case 1:s();break;case 2:c();break;case 3:E();break;case 4:m();break;case 5:h()}}var t=Math.round(5*Math.random())+1;e(t%3==0?1:t%4==0?2:t%5==0?3:t%2==0?4:5),ie++,ie>=re&&clearInterval(G)},se),I=1118481;R=new Physijs.CylinderMesh(new THREE.CylinderGeometry(500,500,5,34),new THREE.MeshLambertMaterial({color:I}),0),R.rotation.x=Math.PI,R.position.set(0,0,0),R.name="plane",R.addEventListener("collision",function(e){e.dead||(e.dead=!0,ne.push(e),ae++),ae>10&&console.log("death")}),n.add(R),r=new THREE.PointLight(16777215,1),r.position.set(0,200,0),n.add(r),requestAnimationFrame(t);var J=new THREE.BoxGeometry(700,700,700),N=[],U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/top1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var U=new THREE.TextureLoader;N.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides1.jpg"),side:THREE.DoubleSide,transparent:!0,needsUpdate:!0}));var _=new THREE.MeshFaceMaterial(N),Y=new THREE.Mesh(J,_);Y.position.y=250,n.add(Y);var ee=new THREE.BoxGeometry(740,740,740),de=[],U=new THREE.TextureLoader;de.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;de.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;de.push(new THREE.MeshBasicMaterial({map:U.load("../images/top2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;de.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;de.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;de.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides2.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ce=new THREE.MeshFaceMaterial(de),le=new THREE.Mesh(ee,ce);le.position.y=245,n.add(le);var Ee=new THREE.BoxGeometry(720,720,720),me=[],U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/top3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;me.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides3.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var ue=new THREE.MeshFaceMaterial(me),he=new THREE.Mesh(Ee,ue);he.position.y=245,n.add(he);var we=new THREE.BoxGeometry(760,760,760),Te=[],U=new THREE.TextureLoader;Te.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;Te.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;Te.push(new THREE.MeshBasicMaterial({map:U.load("../images/top4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;Te.push(new THREE.MeshBasicMaterial({map:U.load("../images/bottom4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;Te.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var U=new THREE.TextureLoader;Te.push(new THREE.MeshBasicMaterial({map:U.load("../images/sides4.jpg"),side:THREE.BackSide,transparent:!0,opacity:0}));var Re=new THREE.MeshFaceMaterial(Te),ge=new THREE.Mesh(we,Re);ge.position.y=245,n.add(ge),T();var He=new THREE.BokehPass(n,o,{focus:1,aperture:.06,maxblur:1.05,width:b,height:j});He.renderToScreen=!0,v=new THREE.EffectComposer(a),v.addPass(new THREE.RenderPass(n,o)),v.addPass(He),o.lookAt(new THREE.Vector3(0,20,-100)),document.addEventListener("mousedown",function(){function t(){console.log(P),n.remove(Y);for(var e=0;e<he.material.materials.length;e++)TweenLite.to(he.material.materials[e],3,{opacity:1})}function a(){console.log(P),n.remove(he);for(var e=0;e<le.material.materials.length;e++)TweenLite.to(le.material.materials[e],3,{opacity:1})}function i(){console.log(P),n.remove(le);for(var e=0;e<ge.material.materials.length;e++)TweenLite.to(ge.material.materials[e],3,{opacity:1})}var r=new THREE.Vector2;r.x=0,r.y=0,k.setFromCamera(r,o);for(var s=k.intersectObjects(n.children),d=0;d<s.length;d++)if("plane"==s[d].object.name||"Points"==s[d].object.type||s[d].object.dead||(s[d].object.material.wireframe=!0,s[d].object.dead=!0,oe.push(s[d].object),B++,$(L).text(B)),B>=10*P){se-=400*P,Q+=30*P,K-=30,n.setGravity(new THREE.Vector3(0,K,0)),console.log("next up! Level "+P+", dropInterval: "+se,"dropRadius: "+Q+", gravity: "+K),ae=0,console.log(ne);for(var d=0;d<ne.length;d++)console.log(ne[d]),n.remove(ne[d]);switch(P){case 1:for(var d=0;d<Y.material.materials.length;d++)TweenLite.to(Y.material.materials[d],5,{opacity:0,onComplete:t});break;case 2:for(var d=0;d<he.material.materials.length;d++)TweenLite.to(he.material.materials[d],5,{opacity:0,onComplete:a});break;case 3:for(var d=0;d<le.material.materials.length;d++)TweenLite.to(le.material.materials[d],5,{opacity:0,onComplete:i})}P++,e(P)}},!1),e(P)},window.onerror=function(){return!0},t=function(){if(g.tick(y.getDelta()),S){var e=performance.now(),i=(e-W)/500;O.x-=10*O.x*i,O.z-=10*O.z*i,O.y-=9.8*100*i,z&&(O.z-=400*i),C&&(O.z+=400*i),F&&(O.x-=400*i),A&&(O.x+=400*i),f.getObject().translateX(O.x*i),f.getObject().translateY(O.y*i),f.getObject().translateZ(O.z*i),f.getObject().position.y<10&&(O.y=0,f.getObject().position.y=10),W=e}oe.length>0&&oe.forEach(function(e){e.__dirtyPosition=!0,e.__dirtyRotation=!0,e.setLinearVelocity(new THREE.Vector3(0,0,0)),e.setAngularVelocity(new THREE.Vector3(0,0,0)),e.material.opacity=.5}),requestAnimationFrame(t),n.simulate(),a.render(n,o)},e()});